<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quantum Factory üéÆ - Jeu Idle Factory Sci-Fi</title>
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè≠</text></svg>">
    <meta name="theme-color" content="#0a0e17">
    <meta name="description" content="Jeu idle/factory sci-fi - Cr√©ez votre usine quantique, connectez des machines, compl√©tez des missions et explorez des dimensions alternatives !">
    <style>
        /* =============================================================================
           RESET & BASE STYLES
           ============================================================================= */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: #0a0e17;
            color: #e0e0ff;
            touch-action: manipulation;
        }

        body {
            background: radial-gradient(circle at center, #0a0e17 0%, #050811 100%);
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(0, 150, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(150, 0, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        /* =============================================================================
           LOADING SCREEN
           ============================================================================= */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a0e17;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-content {
            text-align: center;
            animation: pulse 2s infinite;
        }

        .quantum-loader {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            border: 3px solid rgba(0, 150, 255, 0.3);
            border-top-color: #00aaff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .loading-content h2 {
            color: #00aaff;
            margin-bottom: 10px;
            font-size: 1.2rem;
            text-shadow: 0 0 10px rgba(0, 170, 255, 0.5);
        }

        .loading-content p {
            color: #8899cc;
            font-size: 0.9rem;
        }

        .loading-progress {
            margin-top: 20px;
            width: 100%;
            max-width: 300px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(30, 35, 50, 0.8);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00aaff, #00ffaa);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            text-align: center;
            color: #8899cc;
            font-size: 0.9rem;
        }

        /* =============================================================================
           GAME CONTAINER
           ============================================================================= */
        .game-container {
            position: relative;
            width: 100%;
            height: 100vh;
            max-width: 800px;
            margin: 0 auto;
            padding: env(safe-area-inset-top, 10px) env(safe-area-inset-right, 10px) 
                     env(safe-area-inset-bottom, 80px) env(safe-area-inset-left, 10px);
            display: flex;
            flex-direction: column;
            z-index: 1;
        }

        /* =============================================================================
           HEADER - RESSOURCES & NIVEAU
           ============================================================================= */
        .game-header {
            padding: 12px 15px;
            background: rgba(20, 25, 40, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 150, 255, 0.3);
            border-radius: 12px 12px 0 0;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .resources {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .resource {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(30, 35, 50, 0.8);
            border-radius: 20px;
            border: 1px solid rgba(100, 150, 255, 0.2);
            transition: all 0.3s ease;
            min-width: 80px;
        }

        .resource:hover {
            border-color: rgba(100, 150, 255, 0.5);
            transform: translateY(-1px);
        }

        .resource-icon {
            font-size: 1.2rem;
            filter: drop-shadow(0 0 5px currentColor);
        }

        #resource-energy .resource-icon { color: #00ffaa; }
        #resource-matter .resource-icon { color: #ffaa00; }
        #resource-money .resource-icon { color: #00ff55; }
        #resource-research .resource-icon { color: #aa00ff; }
        #resource-quantum .resource-icon { color: #ff55ff; }

        .resource-value {
            font-weight: bold;
            font-size: 1.1rem;
            font-family: 'Courier New', monospace;
            color: #ffffff;
            text-shadow: 0 0 10px currentColor;
        }

        .player-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        .level-display {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .level-label {
            font-size: 0.85rem;
            color: #8899cc;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .level-value {
            font-weight: bold;
            font-size: 1.3rem;
            color: #00aaff;
            text-shadow: 0 0 15px rgba(0, 170, 255, 0.7);
        }

        .xp-bar-container {
            width: 150px;
            height: 6px;
            background: rgba(30, 35, 50, 0.8);
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .xp-bar-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(0, 170, 255, 0.3) 50%, 
                transparent 100%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .xp-bar {
            height: 100%;
            background: linear-gradient(90deg, #00aaff, #00ffaa);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* =============================================================================
           √âV√âNEMENTS SAISONNIERS
           ============================================================================= */
        .events-bar {
            padding: 8px 15px;
            background: linear-gradient(90deg, rgba(255, 85, 85, 0.2), rgba(255, 170, 0, 0.2));
            border-bottom: 2px solid rgba(255, 170, 0, 0.5);
            margin-bottom: 10px;
            animation: pulse-glow 2s infinite;
        }

        .event-active {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #ffffff;
            font-weight: bold;
        }

        .event-icon {
            font-size: 1.5rem;
            animation: float 3s ease-in-out infinite;
        }

        .event-name {
            flex: 1;
            text-shadow: 0 0 10px currentColor;
        }

        .event-timer {
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            background: rgba(0, 0, 0, 0.3);
            padding: 4px 8px;
            border-radius: 8px;
            color: #00ffaa;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }

        @keyframes pulse-glow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* =============================================================================
           MAIN GAME AREA - GRID AVEC CONNEXIONS
           ============================================================================= */
        .game-main {
            flex: 1;
            overflow: auto;
            padding: 10px;
            position: relative;
        }

        .grid-container {
            display: grid;
            gap: 8px;
            margin: 0 auto;
            max-width: 500px;
            touch-action: pan-x pan-y;
            position: relative;
            z-index: 2;
        }

        .connection-canvas {
            position: absolute;
            top: 10px;
            left: 10px;
            width: calc(100% - 20px);
            height: calc(100% - 20px);
            pointer-events: none;
            z-index: 1;
        }

        .grid-cell {
            aspect-ratio: 1;
            background: rgba(30, 35, 50, 0.6);
            border: 2px solid rgba(100, 150, 255, 0.1);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            z-index: 3;
        }

        .grid-cell::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, 
                rgba(100, 150, 255, 0.1) 0%, 
                transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .grid-cell:hover::before,
        .grid-cell:active::before {
            opacity: 1;
        }

        .grid-cell.locked {
            background: rgba(20, 25, 40, 0.4);
            border-color: rgba(255, 50, 50, 0.2);
            cursor: not-allowed;
        }

        .grid-cell.locked::after {
            content: 'üîí';
            position: absolute;
            font-size: 0.8rem;
            opacity: 0.5;
        }

        .grid-cell.occupied {
            border-style: dashed;
        }

        .grid-cell.active {
            border-color: #00ffaa;
            box-shadow: 0 0 15px rgba(0, 255, 170, 0.3);
        }

        .grid-cell.inactive {
            border-color: #ff5555;
            opacity: 0.7;
        }

        .grid-cell.chain-active {
            border-color: #ffaa00;
            box-shadow: 0 0 20px rgba(255, 170, 0, 0.5);
        }

        .grid-cell.connected::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px solid rgba(0, 255, 255, 0.5);
            border-radius: 10px;
            animation: pulse-border 2s infinite;
        }

        @keyframes pulse-border {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .machine-content {
            text-align: center;
            position: relative;
            z-index: 4;
        }

        .machine-icon {
            font-size: 1.8rem;
            margin-bottom: 4px;
            display: block;
            filter: drop-shadow(0 0 8px currentColor);
        }

        .machine-level {
            font-size: 0.7rem;
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 6px;
            border-radius: 10px;
            color: #ffffff;
            position: absolute;
            top: -5px;
            right: -5px;
        }

        /* =============================================================================
           INDICATEUR DE CHA√éNE
           ============================================================================= */
        .chain-indicator {
            position: fixed;
            top: 120px;
            right: 20px;
            background: rgba(40, 45, 60, 0.95);
            border: 2px solid #ffaa00;
            border-radius: 10px;
            padding: 10px 15px;
            color: #ffaa00;
            font-weight: bold;
            z-index: 100;
            box-shadow: 0 5px 15px rgba(255, 170, 0, 0.3);
            animation: slideInRight 0.3s ease;
        }

        #chain-bonus {
            background: rgba(255, 170, 0, 0.2);
            padding: 2px 6px;
            border-radius: 5px;
        }

        /* =============================================================================
           CONTEXT MENU
           ============================================================================= */
        .context-menu {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(20, 25, 40, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 150, 255, 0.3);
            border-radius: 15px;
            width: 280px;
            max-width: 90vw;
            z-index: 1000;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            animation: menuAppear 0.3s ease;
        }

        @keyframes menuAppear {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .context-header {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(100, 150, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .context-title {
            font-weight: bold;
            color: #00aaff;
            font-size: 1.1rem;
        }

        .context-close {
            background: none;
            border: none;
            color: #8899cc;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0 5px;
            transition: color 0.3s ease;
        }

        .context-close:hover {
            color: #ff5555;
        }

        .context-actions {
            padding: 10px 0;
        }

        .context-action {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(100, 150, 255, 0.1);
        }

        .context-action:last-child {
            border-bottom: none;
        }

        .context-action:hover {
            background: rgba(0, 150, 255, 0.1);
        }

        .action-icon {
            font-size: 1.3rem;
            width: 30px;
            text-align: center;
        }

        .action-text {
            flex: 1;
            color: #e0e0ff;
        }

        .action-cost {
            font-size: 0.9rem;
            color: #8899cc;
            font-family: 'Courier New', monospace;
        }

        .action-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action-disabled:hover {
            background: inherit;
        }

        /* =============================================================================
           MACHINE SELECTOR
           ============================================================================= */
        .machine-selector {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 23, 0.95);
            z-index: 1001;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(100, 150, 255, 0.3);
        }

        .selector-header h3 {
            color: #00aaff;
            font-size: 1.3rem;
        }

        .selector-close {
            background: none;
            border: none;
            color: #8899cc;
            font-size: 2rem;
            cursor: pointer;
            padding: 0 10px;
        }

        .machine-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            flex: 1;
        }

        .machine-card {
            background: rgba(30, 35, 50, 0.8);
            border: 2px solid rgba(100, 150, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .machine-card:hover {
            border-color: rgba(100, 150, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .machine-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .machine-card.disabled:hover {
            transform: none;
            border-color: rgba(100, 150, 255, 0.2);
        }

        .machine-icon-large {
            font-size: 2.5rem;
            margin-bottom: 5px;
        }

        .machine-name {
            font-weight: bold;
            font-size: 1rem;
            color: #ffffff;
        }

        .machine-desc {
            font-size: 0.85rem;
            color: #8899cc;
            margin-bottom: 10px;
            flex: 1;
        }

        .machine-cost {
            font-size: 0.9rem;
            color: #ffaa00;
            font-family: 'Courier New', monospace;
        }

        .machine-level-req {
            font-size: 0.8rem;
            color: #ff5555;
            margin-top: 5px;
        }

        /* =============================================================================
           RESEARCH OVERLAY
           ============================================================================= */
        .research-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 23, 0.98);
            z-index: 1002;
            overflow-y: auto;
        }

        .overlay-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .overlay-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(0, 170, 255, 0.3);
        }

        .overlay-header h2 {
            color: #00aaff;
            font-size: 1.5rem;
            text-shadow: 0 0 20px rgba(0, 170, 255, 0.5);
        }

        .overlay-close {
            background: none;
            border: none;
            color: #8899cc;
            font-size: 2rem;
            cursor: pointer;
            padding: 0 10px;
        }

        .research-tree {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }

        .research-branch {
            flex: 1;
            min-width: 250px;
            background: rgba(30, 35, 50, 0.6);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid;
        }

        .branch-production { border-color: #00ffaa; }
        .branch-energy { border-color: #00aaff; }
        .branch-automation { border-color: #aa00ff; }

        .branch-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid currentColor;
        }

        .branch-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .research-node {
            background: rgba(40, 45, 60, 0.8);
            border: 2px solid;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .research-node.completed {
            border-color: #00ff55;
            background: rgba(0, 255, 85, 0.1);
        }

        .research-node.available:not(.completed) {
            border-color: #ffaa00;
            cursor: pointer;
        }

        .research-node.available:not(.completed):hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 170, 0, 0.3);
        }

        .research-node.locked {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #666;
        }

        .node-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .node-name {
            font-weight: bold;
            font-size: 1rem;
        }

        .node-cost {
            background: rgba(0, 0, 0, 0.5);
            padding: 4px 8px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #00aaff;
        }

        .node-desc {
            font-size: 0.9rem;
            color: #8899cc;
            margin-bottom: 10px;
        }

        .node-effect {
            font-size: 0.85rem;
            color: #ffaa00;
            font-style: italic;
        }

        /* =============================================================================
           MISSIONS & QU√äTES
           ============================================================================= */
        .missions-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 23, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1003;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }

        .missions-content {
            background: rgba(20, 25, 40, 0.95);
            border: 2px solid rgba(0, 170, 255, 0.3);
            border-radius: 20px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .missions-header {
            padding: 20px 25px;
            border-bottom: 2px solid rgba(0, 170, 255, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(90deg, rgba(0, 170, 255, 0.1), rgba(0, 255, 170, 0.1));
        }

        .missions-header h2 {
            color: #00aaff;
            font-size: 1.5rem;
            text-shadow: 0 0 20px rgba(0, 170, 255, 0.5);
            margin: 0;
        }

        .missions-close {
            background: none;
            border: none;
            color: #8899cc;
            font-size: 2rem;
            cursor: pointer;
            padding: 0 10px;
            transition: color 0.3s ease;
        }

        .missions-close:hover {
            color: #ff5555;
        }

        .missions-tabs {
            display: flex;
            background: rgba(30, 35, 50, 0.8);
            border-bottom: 1px solid rgba(100, 150, 255, 0.2);
        }

        .tab-btn {
            flex: 1;
            background: none;
            border: none;
            color: #8899cc;
            padding: 15px 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-btn:hover {
            color: #e0e0ff;
            background: rgba(0, 150, 255, 0.1);
        }

        .tab-btn.active {
            color: #00aaff;
            background: rgba(0, 170, 255, 0.2);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #00aaff, #00ffaa);
        }

        .missions-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Daily Missions */
        .daily-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(30, 35, 50, 0.6);
            border-radius: 10px;
            border: 1px solid rgba(0, 170, 255, 0.2);
        }

        .streak-display, .completed-today {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .streak-label, .completed-label {
            color: #8899cc;
            font-size: 0.9rem;
        }

        .streak-value, .completed-value {
            font-weight: bold;
            color: #00ffaa;
            font-size: 1.1rem;
        }

        .missions-list, .achievements-list, .quests-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .mission-item, .achievement-item, .quest-item {
            background: rgba(40, 45, 60, 0.8);
            border: 2px solid rgba(100, 150, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            gap: 15px;
            transition: all 0.3s ease;
            position: relative;
        }

        .mission-item:hover, .achievement-item:hover, .quest-item:hover {
            border-color: rgba(100, 150, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .mission-item.completed, .quest-item.completed {
            border-color: #00ff55;
            background: rgba(0, 255, 85, 0.1);
        }

        .achievement-item.locked, .quest-item.locked {
            opacity: 0.5;
            filter: grayscale(0.7);
        }

        .mission-icon, .quest-icon {
            font-size: 2rem;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .mission-details, .quest-details {
            flex: 1;
        }

        .mission-header, .quest-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .mission-title, .quest-title {
            font-weight: bold;
            font-size: 1.1rem;
            color: #ffffff;
        }

        .mission-progress, .quest-progress {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #00aaff;
            background: rgba(0, 0, 0, 0.3);
            padding: 3px 8px;
            border-radius: 10px;
        }

        .mission-description, .quest-description {
            color: #8899cc;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .mission-progress-bar, .quest-progress-bar {
            height: 6px;
            background: rgba(30, 35, 50, 0.8);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .mission-progress-fill, .quest-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00aaff, #00ffaa);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .mission-reward, .quest-reward {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .reward-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.85rem;
            color: #ffaa00;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .mission-completed, .quest-completed {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 30px;
            height: 30px;
            background: #00ff55;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #0a0e17;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 0 0 15px rgba(0, 255, 85, 0.7);
        }

        /* Qu√™tes sp√©cifiques */
        .quest-progress {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(30, 35, 50, 0.6);
            border-radius: 10px;
        }

        .quest-chapter {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .chapter-label {
            color: #8899cc;
            font-size: 0.9rem;
        }

        .chapter-name {
            font-weight: bold;
            color: #00aaff;
            font-size: 1.1rem;
        }

        .quest-progress-bar {
            height: 8px;
            border-radius: 4px;
            background: rgba(30, 35, 50, 0.8);
            overflow: hidden;
        }

        .quest-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #aa00ff, #ff55ff);
            transition: width 0.5s ease;
        }

        /* Achievements */
        .achievements-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(30, 35, 50, 0.6);
            border-radius: 10px;
        }

        .stat {
            background: rgba(40, 45, 60, 0.8);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .stat-label {
            display: block;
            color: #8899cc;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .stat-value {
            display: block;
            font-weight: bold;
            font-size: 1.2rem;
            color: #00ffaa;
        }

        .achievement-icon {
            font-size: 2.5rem;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            position: relative;
        }

        .achievement-check {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: #00ff55;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #0a0e17;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .achievement-details {
            flex: 1;
        }

        .achievement-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .achievement-title {
            font-weight: bold;
            font-size: 1.1rem;
            color: #ffffff;
        }

        .achievement-tier {
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 3px 8px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
        }

        .achievement-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .achievement-progress-bar {
            flex: 1;
            height: 8px;
            background: rgba(30, 35, 50, 0.8);
            border-radius: 4px;
            overflow: hidden;
        }

        .achievement-progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .achievement-item.bronze .achievement-progress-fill {
            background: linear-gradient(90deg, #cd7f32, #ffa54d);
        }

        .achievement-item.silver .achievement-progress-fill {
            background: linear-gradient(90deg, #c0c0c0, #ffffff);
        }

        .achievement-item.gold .achievement-progress-fill {
            background: linear-gradient(90deg, #ffd700, #fff8c9);
        }

        .achievement-progress-text {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #00aaff;
            min-width: 60px;
            text-align: right;
        }

        /* Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .mission-stat {
            background: rgba(40, 45, 60, 0.8);
            border: 1px solid rgba(100, 150, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .mission-stat-label {
            color: #8899cc;
            font-size: 0.85rem;
            margin-bottom: 5px;
        }

        .mission-stat-value {
            font-weight: bold;
            font-size: 1.2rem;
            color: #00ffaa;
            font-family: 'Courier New', monospace;
        }

        /* =============================================================================
           PRESTIGE SYSTEM
           ============================================================================= */
        .prestige-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 23, 0.98);
            z-index: 1004;
            overflow-y: auto;
        }

        .prestige-info {
            background: rgba(30, 35, 50, 0.6);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid rgba(255, 85, 255, 0.3);
        }

        .prestige-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .prestige-stat {
            background: rgba(40, 45, 60, 0.8);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .prestige-stat .stat-label {
            display: block;
            color: #8899cc;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .prestige-stat .stat-value {
            display: block;
            font-weight: bold;
            font-size: 1.3rem;
            color: #ff55ff;
        }

        .dimensions-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .dimension-card {
            background: rgba(40, 45, 60, 0.8);
            border: 2px solid;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dimension-card.active {
            border-color: #ff55ff;
            background: rgba(255, 85, 255, 0.1);
            transform: scale(1.05);
        }

        .dimension-card.locked {
            opacity: 0.5;
            filter: grayscale(1);
            cursor: not-allowed;
        }

        .dimension-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .dimension-name {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .dimension-bonus {
            font-size: 0.9rem;
            color: #ffaa00;
        }

        .dimension-requirement {
            font-size: 0.8rem;
            color: #ff5555;
            margin-top: 5px;
        }

        .prestige-action {
            background: rgba(30, 35, 50, 0.6);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }

        .prestige-cost h3 {
            color: #ffd700;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .prestige-cost p {
            color: #8899cc;
            margin-bottom: 10px;
        }

        .cost-details {
            color: #ffaa00 !important;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .prestige-btn {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            border: none;
            border-radius: 50px;
            color: #0a0e17;
            font-size: 1.2rem;
            font-weight: bold;
            padding: 15px 40px;
            margin-top: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        }

        .prestige-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.7);
        }

        .prestige-btn:active {
            transform: translateY(-1px);
        }

        /* =============================================================================
           FOOTER - ACTION BUTTONS
           ============================================================================= */
        .game-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(20, 25, 40, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0, 150, 255, 0.3);
            padding: 12px 20px calc(12px + env(safe-area-inset-bottom, 0px));
            display: flex;
            justify-content: space-around;
            gap: 10px;
            z-index: 100;
        }

        .action-btn {
            flex: 1;
            background: rgba(30, 35, 50, 0.8);
            border: 2px solid rgba(100, 150, 255, 0.2);
            border-radius: 50px;
            color: #e0e0ff;
            padding: 15px 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            font-size: 1.2rem;
            min-height: 70px;
            max-width: 80px;
            position: relative;
        }

        .action-btn:hover {
            border-color: rgba(100, 150, 255, 0.5);
            transform: translateY(-2px);
        }

        .action-btn:active {
            transform: translateY(0);
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #00aaff, #00ffaa);
            color: #0a0e17;
            border: none;
            font-weight: bold;
        }

        .action-btn.primary:hover {
            filter: brightness(1.2);
            box-shadow: 0 5px 20px rgba(0, 170, 255, 0.4);
        }

        .btn-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: bold;
        }

        .missions-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff5555;
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            display: none;
            box-shadow: 0 0 10px rgba(255, 85, 85, 0.7);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* =============================================================================
           INFO PANEL
           ============================================================================= */
        .info-panel {
            position: fixed;
            bottom: 100px;
            right: 20px;
            background: rgba(20, 25, 40, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 150, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            max-width: 300px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 99;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .info-content h3 {
            color: #00aaff;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .info-content p {
            color: #8899cc;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        /* =============================================================================
           NOTIFICATIONS
           ============================================================================= */
        .event-notification {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-100%);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .event-notification-content {
            background: rgba(20, 25, 40, 0.95);
            border: 3px solid rgba(255, 170, 0, 0.5);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            gap: 15px;
            align-items: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .event-notification-icon {
            font-size: 2.5rem;
        }

        .event-notification-details {
            flex: 1;
        }

        .event-notification-title {
            color: #ffaa00;
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .event-notification-name {
            color: #ffffff;
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        .event-notification-desc {
            color: #8899cc;
            font-size: 0.9rem;
        }

        .quest-notification {
            position: fixed;
            bottom: 120px;
            left: 20px;
            z-index: 10000;
            max-width: 300px;
            animation: slideInRight 0.5s ease;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(-100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .quest-notification-content {
            background: rgba(20, 25, 40, 0.95);
            border: 3px solid rgba(0, 170, 255, 0.5);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            gap: 15px;
            align-items: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .quest-notification-icon {
            font-size: 2rem;
            color: #00aaff;
        }

        .quest-notification-details {
            flex: 1;
        }

        .quest-notification-title {
            color: #00aaff;
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .quest-notification-name {
            color: #ffffff;
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .quest-notification-desc {
            color: #8899cc;
            font-size: 0.85rem;
        }

        .achievement-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
            transform: translateX(120%);
            transition: transform 0.5s ease;
        }

        .achievement-notification.show {
            transform: translateX(0);
        }

        .achievement-notification-content {
            background: rgba(20, 25, 40, 0.95);
            border: 3px solid;
            border-radius: 15px;
            padding: 20px;
            display: flex;
            gap: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }

        .achievement-notification-icon {
            font-size: 3rem;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .achievement-notification-details {
            flex: 1;
        }

        .achievement-notification-title {
            font-weight: bold;
            color: #ffaa00;
            font-size: 1rem;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .achievement-notification-name {
            font-weight: bold;
            color: #ffffff;
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        .achievement-notification-desc {
            color: #8899cc;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .achievement-notification-reward {
            color: #00ffaa;
            font-size: 0.9rem;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* =============================================================================
           SETTINGS OVERLAY
           ============================================================================= */
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 23, 0.98);
            z-index: 1005;
            overflow-y: auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .settings-content {
            background: rgba(20, 25, 40, 0.95);
            border: 2px solid rgba(0, 170, 255, 0.3);
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            animation: slideUp 0.3s ease;
        }

        .settings-header {
            padding: 20px;
            border-bottom: 2px solid rgba(0, 170, 255, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(90deg, rgba(0, 170, 255, 0.1), rgba(0, 255, 170, 0.1));
        }

        .settings-header h2 {
            color: #00aaff;
            font-size: 1.5rem;
            text-shadow: 0 0 20px rgba(0, 170, 255, 0.5);
        }

        .settings-close {
            background: none;
            border: none;
            color: #8899cc;
            font-size: 2rem;
            cursor: pointer;
            padding: 0 10px;
        }

        .settings-body {
            padding: 20px;
            overflow-y: auto;
        }

        .setting-group {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(100, 150, 255, 0.2);
        }

        .setting-group:last-child {
            border-bottom: none;
        }

        .setting-title {
            color: #00aaff;
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .setting-label {
            color: #e0e0ff;
            font-size: 1rem;
        }

        .setting-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider {
            width: 150px;
            height: 8px;
            background: rgba(30, 35, 50, 0.8);
            border-radius: 4px;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #00aaff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 170, 255, 0.5);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(30, 35, 50, 0.8);
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: #8899cc;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #00aaff;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
            background-color: #ffffff;
        }

        .settings-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .settings-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .settings-btn.save {
            background: linear-gradient(135deg, #00aaff, #00ffaa);
            color: #0a0e17;
        }

        .settings-btn.reset {
            background: rgba(255, 85, 85, 0.2);
            color: #ff5555;
            border: 1px solid rgba(255, 85, 85, 0.3);
        }

        .settings-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* =============================================================================
           AUDIO SYSTEM
           ============================================================================= */
        .audio-indicator {
            position: fixed;
            bottom: 100px;
            left: 20px;
            width: 40px;
            height: 40px;
            background: rgba(20, 25, 40, 0.9);
            border: 2px solid rgba(100, 150, 255, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 98;
            transition: all 0.3s ease;
        }

        .audio-indicator:hover {
            transform: scale(1.1);
            border-color: rgba(100, 150, 255, 0.6);
        }

        .audio-indicator.muted {
            opacity: 0.5;
        }

        /* =============================================================================
           ANIMATIONS
           ============================================================================= */
        .particle {
            position: absolute;
            pointer-events: none;
            border-radius: 50%;
            z-index: 1;
        }

        .quantum-particle {
            background: radial-gradient(circle, rgba(0, 170, 255, 0.8), transparent 70%);
            box-shadow: 0 0 20px rgba(0, 170, 255, 0.5);
        }

        .energy-particle {
            background: radial-gradient(circle, rgba(0, 255, 170, 0.8), transparent 70%);
            box-shadow: 0 0 20px rgba(0, 255, 170, 0.5);
        }

        .matter-particle {
            background: radial-gradient(circle, rgba(255, 170, 0, 0.8), transparent 70%);
            box-shadow: 0 0 20px rgba(255, 170, 0, 0.5);
        }

        .research-particle {
            background: radial-gradient(circle, rgba(170, 0, 255, 0.8), transparent 70%);
            box-shadow: 0 0 20px rgba(170, 0, 255, 0.5);
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(10px, -10px) rotate(90deg); }
            50% { transform: translate(0, -20px) rotate(180deg); }
            75% { transform: translate(-10px, -10px) rotate(270deg); }
        }

        @keyframes pulse-glow {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        @keyframes ripple {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(4); opacity: 0; }
        }

        /* =============================================================================
           RESPONSIVE DESIGN
           ============================================================================= */
        @media (max-width: 768px) {
            .game-header {
                flex-direction: column;
                gap: 15px;
                padding: 10px;
            }
            
            .resources {
                justify-content: center;
                width: 100%;
            }
            
            .resource {
                min-width: 70px;
                padding: 5px 10px;
            }
            
            .player-info {
                width: 100%;
                align-items: center;
            }
            
            .xp-bar-container {
                width: 100%;
            }
            
            .grid-container {
                gap: 6px;
            }
            
            .action-btn {
                padding: 12px 5px;
                min-height: 60px;
                font-size: 1.1rem;
            }
            
            .btn-label {
                font-size: 0.7rem;
            }
            
            .research-tree {
                flex-direction: column;
            }
            
            .machine-list {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
            
            .missions-tabs {
                flex-direction: column;
            }
            
            .tab-btn {
                padding: 12px;
                font-size: 0.9rem;
            }
            
            .dimensions-list {
                grid-template-columns: 1fr;
            }
            
            .chain-indicator {
                top: 80px;
                right: 10px;
                font-size: 0.9rem;
                padding: 8px 12px;
            }
        }

        @media (max-width: 480px) {
            .resource {
                min-width: 60px;
                font-size: 0.9rem;
            }
            
            .level-value {
                font-size: 1.1rem;
            }
            
            .game-footer {
                padding: 10px 15px calc(10px + env(safe-area-inset-bottom, 0px));
            }
            
            .action-btn {
                padding: 10px 3px;
                min-height: 55px;
                font-size: 1rem;
            }
            
            .btn-label {
                font-size: 0.65rem;
            }
            
            .context-menu {
                width: 90vw;
            }
            
            .event-notification {
                top: 60px;
                left: 10px;
                right: 10px;
                transform: none;
            }
            
            .quest-notification {
                left: 10px;
                right: 10px;
                max-width: none;
            }
        }

        /* =============================================================================
           SCROLLBAR STYLING
           ============================================================================= */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(30, 35, 50, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(100, 150, 255, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(100, 150, 255, 0.7);
        }

        /* =============================================================================
           UTILITY CLASSES
           ============================================================================= */
        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        .text-glow {
            text-shadow: 0 0 10px currentColor;
        }

        /* Production animation */
        .production-effect {
            position: absolute;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            color: #00ffaa;
            font-weight: bold;
            text-shadow: 0 0 10px currentColor;
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px);
            }
        }

        /* Styles pour mobile */
        .mobile-instructions {
            text-align: center;
            padding: 15px;
            background: rgba(30, 35, 50, 0.6);
            border-radius: 10px;
            margin: 20px auto;
            max-width: 500px;
            color: #8899cc;
            font-size: 0.9rem;
            display: none;
        }

        @media (max-width: 768px) {
            .mobile-instructions {
                display: block;
            }
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10001;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 300px;
        }

        .toast {
            background: rgba(20, 25, 40, 0.95);
            border: 1px solid rgba(100, 150, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            color: white;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast-info {
            border-left: 4px solid #00aaff;
        }

        .toast-success {
            border-left: 4px solid #00ff55;
        }

        .toast-error {
            border-left: 4px solid #ff5555;
        }

        .toast-warning {
            border-left: 4px solid #ffaa00;
        }
    </style>
</head>
<body>
    <!-- Overlay de chargement -->
    <div id="loading" class="loading-screen">
        <div class="loading-content">
            <div class="quantum-loader"></div>
            <h2>Initialisation quantique...</h2>
            <p>Chargement de l'usine</p>
            <div class="loading-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="loading-progress"></div>
                </div>
                <div class="progress-text" id="loading-text">0%</div>
            </div>
        </div>
    </div>

    <!-- Interface principale -->
    <div class="game-container">
        <!-- En-t√™te avec ressources -->
        <header class="game-header">
            <div class="resources">
                <div class="resource" id="resource-energy" title="√ânergie">
                    <span class="resource-icon">‚ö°</span>
                    <span class="resource-value">10</span>
                </div>
                <div class="resource" id="resource-matter" title="Mati√®re">
                    <span class="resource-icon">üß±</span>
                    <span class="resource-value">0</span>
                </div>
                <div class="resource" id="resource-money" title="Argent">
                    <span class="resource-icon">üí∞</span>
                    <span class="resource-value">50</span>
                </div>
                <div class="resource" id="resource-research" title="Recherche">
                    <span class="resource-icon">üß™</span>
                    <span class="resource-value">0</span>
                </div>
                <div class="resource" id="resource-quantum" title="C≈ìurs Quantiques">
                    <span class="resource-icon">üîÆ</span>
                    <span class="resource-value">0</span>
                </div>
            </div>
            
            <div class="player-info">
                <div class="level-display">
                    <span class="level-label">Niveau</span>
                    <span class="level-value">1</span>
                </div>
                <div class="xp-bar-container">
                    <div class="xp-bar" id="xp-bar" style="width: 0%"></div>
                </div>
            </div>
        </header>

        <!-- Barre d'√©v√©nements -->
        <div class="events-bar" id="events-bar" style="display: none">
            <div class="event-active" id="active-event">
                <span class="event-icon">üå™Ô∏è</span>
                <span class="event-name">Temp√™te Quantique</span>
                <span class="event-timer" id="event-timer">01:30</span>
            </div>
        </div>

        <!-- Grille de jeu avec connexions -->
        <main class="game-main">
            <div class="grid-container" id="game-grid">
                <!-- La grille sera g√©n√©r√©e dynamiquement -->
            </div>
            <canvas id="connection-canvas" class="connection-canvas"></canvas>
            
            <!-- Instructions pour mobile -->
            <div class="mobile-instructions">
                <p>üëÜ <strong>Appuyez</strong> pour placer une machine</p>
                <p>üëÜ <strong>Appuyez longuement</strong> pour les actions</p>
                <p>üîó <strong>Connectez</strong> les machines pour des bonus !</p>
            </div>
        </main>

        <!-- Indicateur de cha√Æne active -->
        <div class="chain-indicator" id="chain-indicator" style="display: none">
            <span class="chain-icon">üîó</span>
            Cha√Æne active: <span id="chain-bonus">+0%</span>
        </div>

        <!-- Menu contextuel -->
        <div class="context-menu" id="context-menu" style="display: none">
            <div class="context-header">
                <span class="context-title">Actions</span>
                <button class="context-close" id="context-close" aria-label="Fermer">√ó</button>
            </div>
            <div class="context-actions" id="context-actions"></div>
        </div>

        <!-- Menu de s√©lection de machines -->
        <div class="machine-selector" id="machine-selector" style="display: none">
            <div class="selector-header">
                <h3>üè≠ Placer une machine</h3>
                <button class="selector-close" id="selector-close" aria-label="Fermer">√ó</button>
            </div>
            <div class="machine-list" id="machine-list"></div>
            <div class="selector-footer">
                <p class="hint">üí° Montez de niveau pour d√©bloquer de nouvelles machines</p>
            </div>
        </div>

        <!-- Overlay de recherche -->
        <div class="research-overlay" id="research-overlay" style="display: none">
            <div class="overlay-content">
                <div class="overlay-header">
                    <h2>üåå Arbre de Recherche Quantique</h2>
                    <button class="overlay-close" id="research-close" aria-label="Fermer">√ó</button>
                </div>
                <div class="research-info">
                    <div class="research-resources">
                        <span class="research-icon">üß™</span>
                        <span class="research-value" id="current-research">0</span> points disponibles
                    </div>
                    <div class="research-hint">
                        üí° D√©bloquez des technologies pour am√©liorer votre usine
                    </div>
                </div>
                <div class="research-tree" id="research-tree"></div>
            </div>
        </div>

        <!-- Overlay de missions -->
        <div class="missions-overlay" id="missions-overlay" style="display: none">
            <div class="missions-content">
                <div class="missions-header">
                    <h2>üéØ Missions & Objectifs</h2>
                    <button class="missions-close" id="missions-close" aria-label="Fermer">√ó</button>
                </div>
                <div class="missions-tabs">
                    <button class="tab-btn active" data-tab="daily" aria-label="Missions quotidiennes">
                        <span class="tab-icon">üìÖ</span> Quotidiennes
                    </button>
                    <button class="tab-btn" data-tab="achievements" aria-label="Achievements">
                        <span class="tab-icon">üèÜ</span> Achievements
                    </button>
                    <button class="tab-btn" data-tab="stats" aria-label="Statistiques">
                        <span class="tab-icon">üìä</span> Statistiques
                    </button>
                </div>
                <div class="missions-body">
                    <div class="tab-content active" id="tab-daily">
                        <div class="daily-info">
                            <div class="streak-display">
                                <span class="streak-label">S√©rie de connexion:</span>
                                <span class="streak-value" id="streak-value">0 jours</span>
                            </div>
                            <div class="completed-today">
                                <span class="completed-label">Compl√©t√©es aujourd'hui:</span>
                                <span class="completed-value" id="completed-today">0/3</span>
                            </div>
                        </div>
                        <div class="daily-rewards-info">
                            <div class="reward-next">
                                <span class="reward-label">Prochaine r√©compense quotidienne:</span>
                                <span class="reward-value" id="next-daily-reward">Jour 1</span>
                            </div>
                        </div>
                        <div class="missions-list" id="daily-missions-list"></div>
                    </div>
                    
                    <div class="tab-content" id="tab-achievements">
                        <div class="achievements-stats">
                            <div class="stat">
                                <span class="stat-label">Total compl√©t√©s:</span>
                                <span class="stat-value" id="achievements-completed">0</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Progression:</span>
                                <span class="stat-value" id="achievements-progress">0%</span>
                            </div>
                        </div>
                        <div class="achievements-filter">
                            <button class="filter-btn active" data-filter="all">Tous</button>
                            <button class="filter-btn" data-filter="bronze">Bronze</button>
                            <button class="filter-btn" data-filter="silver">Argent</button>
                            <button class="filter-btn" data-filter="gold">Or</button>
                        </div>
                        <div class="achievements-list" id="achievements-list"></div>
                    </div>
                    
                    <div class="tab-content" id="tab-stats">
                        <div class="stats-header">
                            <h3>üìä Statistiques d√©taill√©es</h3>
                            <div class="stats-time">
                                <span class="time-label">Temps de jeu:</span>
                                <span class="time-value" id="play-time">0s</span>
                            </div>
                        </div>
                        <div class="stats-grid" id="missions-stats"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overlay de prestige -->
        <div class="prestige-overlay" id="prestige-overlay" style="display: none">
            <div class="overlay-content">
                <div class="overlay-header">
                    <h2>üåå Syst√®me de Prestige</h2>
                    <button class="overlay-close" id="prestige-close" aria-label="Fermer">√ó</button>
                </div>
                <div class="prestige-content">
                    <div class="prestige-info">
                        <div class="prestige-stats">
                            <div class="prestige-stat">
                                <span class="stat-label">C≈ìurs Quantiques:</span>
                                <span class="stat-value" id="quantum-cores">0</span>
                            </div>
                            <div class="prestige-stat">
                                <span class="stat-label">Dimension actuelle:</span>
                                <span class="stat-value" id="current-dimension">Alpha</span>
                            </div>
                            <div class="prestige-stat">
                                <span class="stat-label">Bonus global:</span>
                                <span class="stat-value" id="prestige-bonus">+0%</span>
                            </div>
                            <div class="prestige-stat">
                                <span class="stat-label">Completions de prestige:</span>
                                <span class="stat-value" id="prestige-count">0</span>
                            </div>
                        </div>
                        <div class="dimensions-container">
                            <h3>üåê Dimensions disponibles</h3>
                            <div class="dimensions-list" id="dimensions-list"></div>
                        </div>
                    </div>
                    <div class="prestige-action">
                        <div class="prestige-cost">
                            <h3>üåü Prestige disponible!</h3>
                            <p>R√©initialisez votre usine pour gagner 1 C≈ìur Quantique</p>
                            <div class="cost-details">
                                <p><strong>Bonus permanent:</strong> <span id="next-bonus">+10%</span> production globale</p>
                                <p><strong>Co√ªt actuel:</strong> <span id="prestige-cost">10,000</span> üí∞</p>
                                <p><strong>√âtat:</strong> <span id="prestige-status" class="status-available">Disponible</span></p>
                            </div>
                        </div>
                        <button class="prestige-btn" id="prestige-btn">üåü PRESTIGE</button>
                        <div class="prestige-warning">
                            <p>‚ö†Ô∏è Le prestige r√©initialise votre usine mais conserve vos c≈ìurs quantiques</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overlay de param√®tres -->
        <div class="settings-overlay" id="settings-overlay" style="display: none">
            <div class="settings-content">
                <div class="settings-header">
                    <h2>‚öôÔ∏è Param√®tres</h2>
                    <button class="settings-close" id="settings-close" aria-label="Fermer">√ó</button>
                </div>
                <div class="settings-body">
                    <div class="setting-group">
                        <div class="setting-title">
                            <span>üîä Audio</span>
                        </div>
                        <div class="setting-item">
                            <span class="setting-label">Volume g√©n√©ral</span>
                            <div class="setting-control">
                                <input type="range" class="slider" id="master-volume" min="0" max="100" value="80">
                                <span id="master-volume-value">80%</span>
                            </div>
                        </div>
                        <div class="setting-item">
                            <span class="setting-label">Musique d'ambiance</span>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="music-toggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="setting-item">
                            <span class="setting-label">Effets sonores</span>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="sfx-toggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="setting-group">
                        <div class="setting-title">
                            <span>üéÆ Gameplay</span>
                        </div>
                        <div class="setting-item">
                            <span class="setting-label">Animations</span>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="animations-toggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="setting-item">
                            <span class="setting-label">Notifications</span>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="notifications-toggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="setting-item">
                            <span class="setting-label">Auto-sauvegarde</span>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="autosave-toggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="setting-group">
                        <div class="setting-title">
                            <span>üíæ Sauvegarde</span>
                        </div>
                        <div class="setting-item">
                            <span class="setting-label">Derni√®re sauvegarde:</span>
                            <span class="setting-value" id="last-save-time">Jamais</span>
                        </div>
                        <div class="settings-buttons">
                            <button class="settings-btn save" id="save-btn">üíæ Sauvegarder</button>
                            <button class="settings-btn reset" id="reset-btn">üîÑ R√©initialiser</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Barre d'actions du bas -->
        <footer class="game-footer">
            <button class="action-btn" id="btn-missions" title="Missions" aria-label="Missions">
                <span class="btn-icon">üéØ</span>
                <span class="btn-label">Missions</span>
                <span class="missions-badge" id="missions-badge" style="display: none">0</span>
            </button>
            <button class="action-btn" id="btn-research" title="Recherche" aria-label="Recherche">
                <span class="btn-icon">üî¨</span>
                <span class="btn-label">Recherche</span>
            </button>
            <button class="action-btn primary" id="btn-place" title="Placer une machine" aria-label="Placer une machine">
                <span class="btn-icon">üè≠</span>
                <span class="btn-label">Placer</span>
            </button>
            <button class="action-btn" id="btn-prestige" title="Prestige" aria-label="Prestige">
                <span class="btn-icon">üåü</span>
                <span class="btn-label">Prestige</span>
            </button>
            <button class="action-btn" id="btn-settings" title="Param√®tres" aria-label="Param√®tres">
                <span class="btn-icon">‚öôÔ∏è</span>
                <span class="btn-label">Param√®tres</span>
            </button>
        </footer>

        <!-- Indicateur audio -->
        <div class="audio-indicator" id="audio-indicator" title="Son activ√©">
            <span id="audio-icon">üîä</span>
        </div>

        <!-- Panneau d'information -->
        <div class="info-panel" id="info-panel" style="display: none">
            <div class="info-content"></div>
            <button class="info-close" id="info-close" aria-label="Fermer">√ó</button>
        </div>

        <!-- Notification d'√©v√©nement -->
        <div class="event-notification" id="event-notification" style="display: none">
            <div class="event-notification-content">
                <div class="event-notification-icon" id="event-notif-icon">üå™Ô∏è</div>
                <div class="event-notification-details">
                    <div class="event-notification-title">√âv√©nement sp√©cial!</div>
                    <div class="event-notification-name" id="event-notif-name">Temp√™te Quantique</div>
                    <div class="event-notification-desc" id="event-notif-desc">Production x2 pendant 1 heure!</div>
                </div>
            </div>
        </div>

        <!-- Notification de qu√™te -->
        <div class="quest-notification" id="quest-notification" style="display: none">
            <div class="quest-notification-content">
                <div class="quest-notification-icon">üìú</div>
                <div class="quest-notification-details">
                    <div class="quest-notification-title">Nouvelle qu√™te!</div>
                    <div class="quest-notification-name" id="quest-notif-name"></div>
                    <div class="quest-notification-desc" id="quest-notif-desc"></div>
                </div>
            </div>
        </div>

        <!-- Notification d'achievement -->
        <div class="achievement-notification" id="achievement-notification" style="display: none">
            <div class="achievement-notification-content">
                <div class="achievement-notification-icon" id="achievement-notif-icon">üèÜ</div>
                <div class="achievement-notification-details">
                    <div class="achievement-notification-title">Achievement d√©bloqu√©!</div>
                    <div class="achievement-notification-name" id="achievement-notif-name"></div>
                    <div class="achievement-notification-desc" id="achievement-notif-desc"></div>
                </div>
            </div>
        </div>

        <!-- Notifications toast -->
        <div class="toast-container" id="toast-container"></div>
    </div>

    <!-- JavaScript int√©gr√© -->
    <script>
        // =============================================================================
        // DONN√âES DU JEU
        // =============================================================================
        const GameData = {
            // Types de ressources
            RESOURCE_TYPES: {
                energy: { name: '√ânergie', icon: '‚ö°', color: '#00ffaa' },
                matter: { name: 'Mati√®re', icon: 'üß±', color: '#ffaa00' },
                money: { name: 'Argent', icon: 'üí∞', color: '#00ff55' },
                research: { name: 'Recherche', icon: 'üß™', color: '#aa00ff' },
                quantum: { name: 'C≈ìurs Quantiques', icon: 'üîÆ', color: '#ff55ff' }
            },

            // D√©finitions des machines
            MACHINES: {
                extractor: {
                    type: 'extractor',
                    name: 'Extracteur',
                    icon: 'üß±',
                    description: 'Extrait de la mati√®re brute du sol',
                    color: '#ffaa00',
                    baseCost: { money: 25 },
                    baseProduction: { matter: 1 },
                    baseConsumption: { energy: 1 },
                    requiredLevel: 1,
                    xpOnPlace: 10,
                    chainBonus: { connectsTo: ['factory'], bonus: 0.25 }
                },
                generator: {
                    type: 'generator',
                    name: 'G√©n√©rateur',
                    icon: '‚ö°',
                    description: 'Produit de l\'√©nergie pour alimenter vos machines',
                    color: '#00ffaa',
                    baseCost: { money: 10 },
                    baseProduction: { energy: 2 },
                    baseConsumption: {},
                    requiredLevel: 1,
                    xpOnPlace: 5,
                    chainBonus: { connectsTo: ['extractor', 'factory', 'lab'], bonus: 0.15 }
                },
                factory: {
                    type: 'factory',
                    name: 'Usine',
                    icon: 'üè≠',
                    description: 'Transforme la mati√®re en profit',
                    color: '#00ff55',
                    baseCost: { money: 50 },
                    baseProduction: { money: 5 },
                    baseConsumption: { energy: 2, matter: 1 },
                    requiredLevel: 2,
                    xpOnPlace: 15,
                    chainBonus: { connectsTo: ['extractor'], bonus: 0.3 }
                },
                lab: {
                    type: 'lab',
                    name: 'Laboratoire',
                    icon: 'üß™',
                    description: 'G√©n√®re des points de recherche pour les technologies',
                    color: '#aa00ff',
                    baseCost: { money: 100, matter: 20 },
                    baseProduction: { research: 1 },
                    baseConsumption: { energy: 3 },
                    requiredLevel: 3,
                    xpOnPlace: 25,
                    chainBonus: { connectsTo: ['generator'], bonus: 0.2 }
                }
            },

            // Niveaux du joueur
            PLAYER_LEVELS: [
                { level: 1, xpRequired: 0, gridSize: { width: 3, height: 3 }, unlockedMachines: ['generator', 'extractor'] },
                { level: 2, xpRequired: 50, gridSize: { width: 4, height: 4 }, unlockedMachines: ['factory'] },
                { level: 3, xpRequired: 150, gridSize: { width: 5, height: 5 }, unlockedMachines: ['lab'] },
                { level: 4, xpRequired: 350, gridSize: { width: 6, height: 5 } },
                { level: 5, xpRequired: 600, gridSize: { width: 6, height: 6 } },
                { level: 6, xpRequired: 1000, gridSize: { width: 7, height: 6 } },
                { level: 7, xpRequired: 1500, gridSize: { width: 7, height: 7 } },
                { level: 8, xpRequired: 2500, gridSize: { width: 8, height: 7 } },
                { level: 9, xpRequired: 4000, gridSize: { width: 8, height: 8 } },
                { level: 10, xpRequired: 6000, gridSize: { width: 10, height: 10 } }
            ],

            // Arbre de recherche
            RESEARCH_TREE: [
                // Production
                {
                    id: 'prod_1',
                    name: 'Extraction Efficace',
                    description: '+25% de production pour les extracteurs',
                    branch: 'production',
                    cost: 10,
                    prerequisites: [],
                    effect: { type: 'production_multiplier', target: 'extractor', value: 1.25 },
                    tier: 1
                },
                {
                    id: 'prod_2',
                    name: 'Usine Optimis√©e',
                    description: '+25% de production pour les usines',
                    branch: 'production',
                    cost: 25,
                    prerequisites: ['prod_1'],
                    effect: { type: 'production_multiplier', target: 'factory', value: 1.25 },
                    tier: 2
                },
                {
                    id: 'prod_3',
                    name: 'Production Avanc√©e',
                    description: '+50% de production pour toutes les machines',
                    branch: 'production',
                    cost: 75,
                    prerequisites: ['prod_2'],
                    effect: { type: 'production_multiplier', target: 'all', value: 1.5 },
                    tier: 3
                },

                // √ânergie
                {
                    id: 'energy_1',
                    name: 'Efficacit√© √ânerg√©tique',
                    description: '-20% de consommation d\'√©nergie',
                    branch: 'energy',
                    cost: 10,
                    prerequisites: [],
                    effect: { type: 'consumption_reduction', target: 'energy', value: 0.8 },
                    tier: 1
                },
                {
                    id: 'energy_2',
                    name: 'G√©n√©rateurs Am√©lior√©s',
                    description: '+50% de production pour les g√©n√©rateurs',
                    branch: 'energy',
                    cost: 30,
                    prerequisites: ['energy_1'],
                    effect: { type: 'production_multiplier', target: 'generator', value: 1.5 },
                    tier: 2
                },
                {
                    id: 'energy_3',
                    name: '√ânergie Propre',
                    description: '-40% de consommation d\'√©nergie totale',
                    branch: 'energy',
                    cost: 80,
                    prerequisites: ['energy_2'],
                    effect: { type: 'consumption_reduction', target: 'energy', value: 0.6 },
                    tier: 3
                },

                // Automatisation
                {
                    id: 'auto_1',
                    name: 'Revenu Passif',
                    description: '+1 üí∞/s automatiquement',
                    branch: 'automation',
                    cost: 15,
                    prerequisites: [],
                    effect: { type: 'passive_income', target: 'money', value: 1 },
                    tier: 1
                },
                {
                    id: 'auto_2',
                    name: 'Recherche Passive',
                    description: '+0.5 üß™/s automatiquement',
                    branch: 'automation',
                    cost: 40,
                    prerequisites: ['auto_1'],
                    effect: { type: 'passive_income', target: 'research', value: 0.5 },
                    tier: 2
                },
                {
                    id: 'auto_3',
                    name: 'Automatisation Totale',
                    description: '+100% de production globale',
                    branch: 'automation',
                    cost: 100,
                    prerequisites: ['auto_2'],
                    effect: { type: 'production_multiplier', target: 'all', value: 2 },
                    tier: 3
                }
            ],

            // √âv√©nements saisonniers et sp√©ciaux
            EVENTS: {
                quantum_storm: {
                    id: 'quantum_storm',
                    name: "Temp√™te Quantique",
                    icon: "üå™Ô∏è",
                    description: "Un vortex quantique augmente la production!",
                    duration: 3600,
                    effect: { 
                        production_multiplier: 2.0,
                        energy_consumption: 0.5,
                        visual: "particules lumineuses"
                    },
                    rarity: "rare",
                    minLevel: 3
                },
                matter_overflow: {
                    id: 'matter_overflow',
                    name: "Surflux de Mati√®re",
                    icon: "üíé",
                    description: "Les gisements de mati√®re sont surcharg√©s!",
                    duration: 1800,
                    effect: { 
                        matter_production: 3.0,
                        chance_double_production: 0.3
                    },
                    rarity: "common",
                    minLevel: 2
                },
                energy_crisis: {
                    id: 'energy_crisis',
                    name: "Crise √ânerg√©tique",
                    icon: "‚ö°",
                    description: "Rationnement d'√©nergie en cours!",
                    duration: 2700,
                    effect: { 
                        energy_production: 0.5,
                        consumption_reduction: 0.7,
                        challenge: true
                    },
                    rarity: "uncommon",
                    minLevel: 4
                }
            },

            // Dimensions alternatives (prestige)
            DIMENSIONS: [
                {
                    id: 'alpha',
                    name: "Dimension Alpha",
                    icon: "üî∑",
                    description: "Dimension d'origine, stable et pr√©visible",
                    bonus: { production: 1.0, energy_efficiency: 1.0 },
                    unlocked: true,
                    requirement: null
                },
                {
                    id: 'beta',
                    name: "Dimension B√™ta",
                    icon: "üî∂",
                    description: "√ânergie pure, g√©n√©rateurs surpuissants",
                    bonus: { energy_production: 1.5, generator_efficiency: 1.3 },
                    unlocked: false,
                    requirement: { quantum_cores: 1 }
                },
                {
                    id: 'gamma',
                    name: "Dimension Gamma",
                    icon: "üí†",
                    description: "Mati√®re condens√©e, extraction optimale",
                    bonus: { matter_production: 2.0, extractor_efficiency: 1.5 },
                    unlocked: false,
                    requirement: { quantum_cores: 3 }
                }
            ],

            // Qu√™tes narratives
            STORY_QUESTS: [
                {
                    chapter: 1,
                    title: "L'√âveil Quantique",
                    description: "Commencez votre voyage dans le monde quantique",
                    quests: [
                        {
                            id: 'prologue_1',
                            type: 'place_machine',
                            title: "Premiers Pas",
                            description: "Placez votre premier g√©n√©rateur",
                            icon: "‚ö°",
                            target: 1,
                            reward: { energy: 20, xp: 50 },
                            prerequisite: null
                        },
                        {
                            id: 'prologue_2',
                            type: 'place_machine',
                            title: "Extraction Initiale",
                            description: "Placez un extracteur pour collecter de la mati√®re",
                            icon: "üß±",
                            target: 1,
                            reward: { matter: 10, xp: 75 },
                            prerequisite: 'prologue_1'
                        },
                        {
                            id: 'prologue_3',
                            type: 'produce_resource',
                            title: "Production d'√ânergie",
                            description: "Produisez 100 unit√©s d'√©nergie",
                            icon: "‚ö°",
                            target: 100,
                            reward: { money: 100, xp: 100 },
                            prerequisite: 'prologue_2'
                        }
                    ]
                }
            ],

            // Missions quotidiennes et achievements
            MISSIONS: {
                DAILY_MISSIONS: [
                    {
                        id: 'daily_place_5',
                        type: 'place_machines',
                        title: 'Constructeur D√©butant',
                        description: 'Placez 5 machines',
                        icon: 'üè≠',
                        target: 5,
                        reward: { money: 100, research: 5 },
                        progress: 0,
                        completed: false
                    },
                    {
                        id: 'daily_produce_energy',
                        type: 'produce_resource',
                        resource: 'energy',
                        title: '√ânergie Vitale',
                        description: 'Produisez 1000 unit√©s d\'√©nergie',
                        icon: '‚ö°',
                        target: 1000,
                        reward: { energy: 50, xp: 25 },
                        progress: 0,
                        completed: false
                    },
                    {
                        id: 'daily_upgrade_3',
                        type: 'upgrade_machines',
                        title: 'Am√©liorateur',
                        description: 'Am√©liorez 3 machines',
                        icon: '‚¨ÜÔ∏è',
                        target: 3,
                        reward: { matter: 25, xp: 50 },
                        progress: 0,
                        completed: false
                    }
                ],

                DAILY_LOGIN_REWARDS: [
                    { day: 1, reward: { money: 50, energy: 20 }, icon: 'üéÅ' },
                    { day: 2, reward: { matter: 25, research: 5 }, icon: 'üéÅ' },
                    { day: 3, reward: { money: 100, xp: 50 }, icon: 'üéÅ' },
                    { day: 4, reward: { energy: 100, matter: 50 }, icon: 'üéÅ' },
                    { day: 5, reward: { research: 25, money: 150 }, icon: 'üéÅ' },
                    { day: 6, reward: { energy: 150, matter: 75 }, icon: 'üéÅ' },
                    { day: 7, reward: { money: 500, research: 50, quantum: 1 }, icon: 'üèÜ' }
                ],

                ACHIEVEMENTS: [
                    {
                        id: 'ach_total_machines_10',
                        type: 'total_machines_placed',
                        title: 'Apprenti Ing√©nieur',
                        description: 'Placez 10 machines au total',
                        icon: 'üîß',
                        tier: 'bronze',
                        target: 10,
                        reward: { money: 250, title: 'Apprenti' },
                        progress: 0,
                        completed: false,
                        unlockedAt: 0
                    },
                    {
                        id: 'ach_total_machines_50',
                        type: 'total_machines_placed',
                        title: 'Ing√©nieur Confirm√©',
                        description: 'Placez 50 machines au total',
                        icon: '‚öôÔ∏è',
                        tier: 'silver',
                        target: 50,
                        reward: { money: 1000, research: 100, title: 'Ing√©nieur' },
                        progress: 0,
                        completed: false,
                        unlockedAt: 0
                    },
                    {
                        id: 'ach_consecutive_days_7',
                        type: 'consecutive_login_days',
                        title: 'Joueur Assidu',
                        description: 'Connectez-vous 7 jours cons√©cutifs',
                        icon: 'üìÖ',
                        tier: 'bronze',
                        target: 7,
                        reward: { research: 100, boost: { duration: 86400, multiplier: 1.5 } },
                        progress: 0,
                        completed: false,
                        unlockedAt: 0
                    }
                ]
            },

            // Constantes du jeu
            CONSTANTS: {
                TICK_INTERVAL: 1000,
                UPGRADE_COST_MULTIPLIER: 2,
                UPGRADE_PRODUCTION_MULTIPLIER: 1.5,
                SELL_REFUND_PERCENTAGE: 0.5,
                SAVE_KEY: 'quantum_factory_save',
                SAVE_VERSION: 2,
                CHAIN_BONUS_BASE: 0.1,
                CHAIN_MAX_DISTANCE: 2,
                EVENT_CHANCE: 0.001,
                EVENT_COOLDOWN: 3600,
                PRESTIGE_BASE_COST: 10000,
                PRESTIGE_COST_MULTIPLIER: 5,
                QUANTUM_CORE_BONUS: 0.1
            },

            // Couleurs pour les tiers d'achievements
            ACHIEVEMENT_TIER_COLORS: {
                bronze: '#cd7f32',
                silver: '#c0c0c0',
                gold: '#ffd700'
            }
        };

        // =============================================================================
        // MOTEUR DE JEU PRINCIPAL
        // =============================================================================
        const Game = {
            // √âtat du jeu
            state: {
                version: 2,
                resources: {
                    energy: 10,
                    matter: 0,
                    money: 50,
                    research: 0,
                    quantum: 0
                },
                progress: {
                    level: 1,
                    currentXp: 0,
                    totalXp: 0
                },
                grid: [],
                placedMachines: [],
                research: {
                    completed: [],
                    current: null,
                    progress: 0
                },
                missions: {
                    daily: [],
                    achievements: [],
                    completedToday: 0,
                    totalCompleted: 0,
                    streak: 0,
                    lastLoginDate: null,
                    dailyLoginRewards: [],
                    collectedLoginRewards: []
                },
                quests: {
                    currentChapter: 1,
                    completedQuests: [],
                    currentQuest: 'prologue_1',
                    questProgress: {}
                },
                events: {
                    activeEvents: [],
                    lastEventTime: null
                },
                prestige: {
                    quantumCores: 0,
                    currentDimension: 'alpha',
                    unlockedDimensions: ['alpha']
                },
                settings: {
                    masterVolume: 80,
                    musicEnabled: true,
                    sfxEnabled: true,
                    animationsEnabled: true,
                    notificationsEnabled: true,
                    autosaveEnabled: true
                },
                stats: {
                    machinesPlaced: 0,
                    totalProduced: { energy: 0, matter: 0, money: 0, research: 0 },
                    playTime: 0,
                    prestigeCount: 0,
                    chainsCreated: 0,
                    eventsCompleted: 0
                },
                lastTick: Date.now(),
                tutorialCompleted: false,
                lastSaved: null
            },

            // Syst√®mes
            eventSystem: null,
            prestigeSystem: null,
            chainSystem: null,
            questSystem: null,
            audioSystem: null,
            animationSystem: null,

            // Initialisation
            init() {
                console.log('üéÆ Initialisation de Quantum Factory...');
                
                // Charger la sauvegarde
                this.loadGame();
                
                // Initialiser la grille
                this.initGrid();
                
                // Initialiser les syst√®mes
                this.initSystems();
                
                // Initialiser les missions
                this.initMissions();
                
                // D√©marrer la boucle de jeu
                this.startGameLoop();
                
                console.log('‚úÖ Jeu initialis√© !');
            },

            initSystems() {
                // Syst√®me d'√©v√©nements
                this.eventSystem = new EventSystem(this);
                
                // Syst√®me de prestige
                this.prestigeSystem = new PrestigeSystem(this);
                
                // Syst√®me de cha√Ænes
                this.chainSystem = new ChainSystem(this);
                
                // Syst√®me de qu√™tes
                this.questSystem = new QuestSystem(this);
                
                // Syst√®me audio
                this.audioSystem = new AudioSystem(this);
                
                // Syst√®me d'animations
                this.animationSystem = new AnimationSystem(this);
                
                // Initialiser les bonus de dimension
                this.prestigeSystem.calculateDimensionBonuses();
            },

            // Boucle de jeu
            startGameLoop() {
                // Premier tick imm√©diat
                this.gameTick();
                
                // Boucle r√©guli√®re
                setInterval(() => {
                    this.gameTick();
                }, GameData.CONSTANTS.TICK_INTERVAL);
            },

            gameTick() {
                const now = Date.now();
                const deltaTime = (now - this.state.lastTick) / 1000;
                this.state.lastTick = now;
                this.state.stats.playTime += deltaTime;

                // Mettre √† jour les √©v√©nements
                if (this.eventSystem) {
                    this.eventSystem.update();
                }
                
                // Calculer la production
                this.calculateProduction(deltaTime);
                
                // Mettre √† jour les connexions
                if (this.chainSystem) {
                    this.chainSystem.updateConnections();
                }
                
                // Mettre √† jour les animations
                if (this.animationSystem) {
                    this.animationSystem.update(deltaTime);
                }
                
                // Mettre √† jour l'interface
                UI.updateResources();
                UI.updateXp();
                UI.updateGrid();
                
                // Sauvegarder p√©riodiquement
                if (this.state.settings.autosaveEnabled && now % 30000 < 1000) {
                    this.saveGame();
                }
            },

            // Calculs de production avec effets de recherche et bonus
            calculateProduction(deltaTime) {
                let totalProduction = { energy: 0, matter: 0, money: 0, research: 0 };
                let totalConsumption = { energy: 0, matter: 0, money: 0, research: 0 };

                // Production passive des recherches
                if (this.state.research.completed.includes('auto_2')) {
                    totalProduction.research += 0.5 * deltaTime * this.getGlobalProductionMultiplier();
                }
                if (this.state.research.completed.includes('auto_1')) {
                    totalProduction.money += 1 * deltaTime * this.getGlobalProductionMultiplier();
                }

                // Calculer pour chaque machine
                this.state.placedMachines.forEach(machine => {
                    const def = GameData.MACHINES[machine.type];
                    let production = this.getMachineProduction(machine.type, machine.level);
                    let consumption = this.getMachineConsumption(machine.type, machine.level);

                    // Appliquer les bonus de cha√Æne
                    if (this.chainSystem) {
                        const chainBonus = this.chainSystem.getMachineBonus(machine.id);
                        for (const resource in production) {
                            production[resource] *= (1 + chainBonus);
                        }
                    }

                    // Appliquer les bonus de dimension
                    if (this.prestigeSystem) {
                        const dimensionBonus = this.prestigeSystem.getDimensionBonus(machine.type);
                        for (const resource in production) {
                            production[resource] *= dimensionBonus;
                        }
                    }

                    // V√©rifier si la machine a assez de ressources
                    let canProduce = true;
                    for (const [resource, amount] of Object.entries(consumption)) {
                        if (this.state.resources[resource] < amount * deltaTime) {
                            canProduce = false;
                            break;
                        }
                    }

                    machine.isActive = canProduce;

                    if (canProduce) {
                        // Ajouter la production
                        for (const [resource, amount] of Object.entries(production)) {
                            totalProduction[resource] += amount * deltaTime;
                        }
                        
                        // Ajouter la consommation
                        for (const [resource, amount] of Object.entries(consumption)) {
                            totalConsumption[resource] += amount * deltaTime;
                        }
                        
                        // Ajouter XP
                        this.addXp(1 * deltaTime);
                        
                        // Cr√©er des effets visuels
                        if (this.animationSystem && this.state.settings.animationsEnabled) {
                            this.animationSystem.createProductionEffect(machine.position, production);
                        }
                    }
                });

                // Appliquer les modifications
                for (const resource of Object.keys(this.state.resources)) {
                    if (totalProduction[resource]) {
                        this.state.resources[resource] += totalProduction[resource];
                        this.state.stats.totalProduced[resource] += totalProduction[resource];
                    }
                    
                    if (totalConsumption[resource]) {
                        this.state.resources[resource] -= totalConsumption[resource];
                    }
                }
            },

            getGlobalProductionMultiplier() {
                let multiplier = 1.0;
                
                // Bonus des c≈ìurs quantiques
                multiplier *= (1 + (this.state.resources.quantum * GameData.CONSTANTS.QUANTUM_CORE_BONUS));
                
                // Bonus des recherches globales
                if (this.state.research.completed.includes('prod_3')) {
                    multiplier *= 1.5;
                }
                if (this.state.research.completed.includes('auto_3')) {
                    multiplier *= 2.0;
                }
                
                return multiplier;
            },

            // Gestion des machines
            initGrid() {
                const level = GameData.PLAYER_LEVELS.find(l => l.level === this.state.progress.level);
                const { width, height } = level.gridSize;
                
                this.state.grid = [];
                for (let y = 0; y < height; y++) {
                    const row = [];
                    for (let x = 0; x < width; x++) {
                        const isUnlocked = x < 3 && y < 3;
                        row.push({
                            position: { x, y },
                            machine: null,
                            isUnlocked
                        });
                    }
                    this.state.grid.push(row);
                }
                
                // Restaurer les machines
                this.restoreMachinesOnGrid();
            },

            restoreMachinesOnGrid() {
                this.state.placedMachines.forEach(machine => {
                    const cell = this.state.grid[machine.position.y] && 
                                this.state.grid[machine.position.y][machine.position.x];
                    if (cell) {
                        cell.machine = machine;
                    }
                });
            },

            placeMachine(type, position) {
                const def = GameData.MACHINES[type];
                const cost = this.getMachineCost(type, 1);
                
                // V√©rifier les pr√©requis
                if (!this.canPlaceMachine(type, position)) {
                    UI.showNotification('Impossible de placer cette machine', 'error');
                    return false;
                }

                // V√©rifier les ressources
                if (!this.hasEnoughResources(cost)) {
                    UI.showNotification('Ressources insuffisantes', 'error');
                    return false;
                }

                // D√©duire le co√ªt
                this.deductResources(cost);

                // Cr√©er la machine
                const machine = {
                    id: `machine_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    type: type,
                    level: 1,
                    position: position,
                    placedAt: Date.now(),
                    isActive: true
                };

                // Ajouter √† la grille
                const cell = this.state.grid[position.y][position.x];
                cell.machine = machine;
                this.state.placedMachines.push(machine);
                this.state.stats.machinesPlaced++;

                // Ajouter XP
                this.addXp(def.xpOnPlace);

                // Jouer le son
                if (this.audioSystem) {
                    this.audioSystem.playSound('place');
                }

                // Mettre √† jour les missions
                this.hookMissionProgress('place_machine');

                // Mettre √† jour les connexions
                if (this.chainSystem) {
                    this.chainSystem.updateConnections();
                }

                // Mettre √† jour l'interface
                UI.updateGrid();
                UI.updateResources();
                UI.showNotification(`${def.name} plac√©(e) avec succ√®s !`, 'success');

                // Sauvegarder
                this.saveGame();

                return true;
            },

            upgradeMachine(machineId) {
                const machine = this.state.placedMachines.find(m => m.id === machineId);
                if (!machine || machine.level >= 5) {
                    UI.showNotification('Machine d√©j√† au niveau maximum', 'error');
                    return false;
                }

                const def = GameData.MACHINES[machine.type];
                const cost = this.getMachineCost(machine.type, machine.level + 1);
                
                if (!this.hasEnoughResources(cost)) {
                    UI.showNotification('Ressources insuffisantes', 'error');
                    return false;
                }

                // D√©duire le co√ªt
                this.deductResources(cost);

                // Am√©liorer la machine
                machine.level++;

                // Ajouter XP
                this.addXp(def.xpOnPlace * 2);

                // Jouer le son
                if (this.audioSystem) {
                    this.audioSystem.playSound('upgrade');
                }

                // Mettre √† jour l'interface
                UI.updateGrid();
                UI.updateResources();
                UI.showNotification(`${def.name} am√©lior√©(e) au niveau ${machine.level} !`, 'success');

                // Sauvegarder
                this.saveGame();

                return true;
            },

            sellMachine(machineId) {
                const machineIndex = this.state.placedMachines.findIndex(m => m.id === machineId);
                if (machineIndex === -1) return false;

                const machine = this.state.placedMachines[machineIndex];
                const def = GameData.MACHINES[machine.type];
                
                // Calculer le remboursement
                let totalCost = { money: 0, matter: 0, energy: 0, research: 0 };
                for (let level = 1; level <= machine.level; level++) {
                    const cost = this.getMachineCost(machine.type, level);
                    for (const [resource, amount] of Object.entries(cost)) {
                        totalCost[resource] = (totalCost[resource] || 0) + amount;
                    }
                }

                // Appliquer le pourcentage de remboursement
                const refund = this.multiplyResources(totalCost, GameData.CONSTANTS.SELL_REFUND_PERCENTAGE);
                
                // Ajouter les ressources
                this.addResources(refund);

                // Retirer la machine
                const cell = this.state.grid[machine.position.y][machine.position.x];
                cell.machine = null;
                this.state.placedMachines.splice(machineIndex, 1);

                // Jouer le son
                if (this.audioSystem) {
                    this.audioSystem.playSound('sell');
                }

                // Mettre √† jour les connexions
                if (this.chainSystem) {
                    this.chainSystem.updateConnections();
                }

                // Mettre √† jour l'interface
                UI.updateGrid();
                UI.updateResources();
                UI.showNotification(`${def.name} vendu(e) pour ${Math.round(refund.money || 0)}üí∞`, 'info');

                // Sauvegarder
                this.saveGame();

                return true;
            },

            // Recherche et technologies
            startResearch(researchId) {
                const research = GameData.RESEARCH_TREE.find(r => r.id === researchId);
                if (!research) return false;

                // V√©rifier les pr√©requis
                if (!research.prerequisites.every(pre => this.state.research.completed.includes(pre))) {
                    UI.showNotification('Pr√©requis non satisfaits', 'error');
                    return false;
                }

                // V√©rifier les ressources
                if (this.state.resources.research < research.cost) {
                    UI.showNotification('Points de recherche insuffisants', 'error');
                    return false;
                }

                // D√©marrer la recherche
                this.state.research.current = researchId;
                this.state.research.progress = 0;
                
                // D√©duire le co√ªt
                this.state.resources.research -= research.cost;

                // Jouer le son
                if (this.audioSystem) {
                    this.audioSystem.playSound('research');
                }

                // Mettre √† jour l'interface
                UI.updateResources();
                UI.showNotification(`Recherche "${research.name}" d√©marr√©e`, 'info');

                // Sauvegarder
                this.saveGame();

                return true;
            },

            completeResearch(researchId) {
                const research = GameData.RESEARCH_TREE.find(r => r.id === researchId);
                if (!research) return false;

                this.state.research.completed.push(researchId);
                this.state.research.current = null;
                this.state.research.progress = 0;

                // Appliquer les effets
                this.applyResearchEffect(research.effect);

                // Jouer le son
                if (this.audioSystem) {
                    this.audioSystem.playSound('complete');
                }

                UI.showNotification(`Recherche "${research.name}" compl√©t√©e !`, 'success');
                this.saveGame();

                return true;
            },

            applyResearchEffect(effect) {
                console.log(`Effet de recherche appliqu√©: ${effect.type} sur ${effect.target}`);
                // Les effets sont appliqu√©s dans les m√©thodes getMachineProduction et getMachineConsumption
            },

            // Progression du joueur
            addXp(amount) {
                this.state.progress.currentXp += amount;
                this.state.progress.totalXp += amount;

                // V√©rifier le niveau sup√©rieur
                const currentLevel = this.state.progress.level;
                const nextLevel = GameData.PLAYER_LEVELS.find(l => l.level === currentLevel + 1);
                
                if (nextLevel && this.state.progress.currentXp >= nextLevel.xpRequired) {
                    this.levelUp();
                }

                UI.updateXp();
            },

            levelUp() {
                this.state.progress.level++;
                this.state.progress.currentXp = 0;
                
                // Agrandir la grille
                this.initGrid();
                
                // R√©organiser les machines
                this.reorganizeMachines();

                // Jouer le son
                if (this.audioSystem) {
                    this.audioSystem.playSound('levelup');
                }

                UI.updateLevel();
                UI.updateGrid();
                UI.showNotification(`Niveau ${this.state.progress.level} atteint ! Grille agrandie.`, 'success');
            },

            reorganizeMachines() {
                // R√©organise les machines pour s'adapter √† la nouvelle grille
                const newGrid = this.state.grid;
                const placedMachines = [...this.state.placedMachines];
                
                // R√©initialiser la grille
                this.state.placedMachines = [];
                for (let y = 0; y < newGrid.length; y++) {
                    for (let x = 0; x < newGrid[y].length; x++) {
                        newGrid[y][x].machine = null;
                    }
                }
                
                // Replacer les machines dans les nouvelles positions
                placedMachines.forEach(machine => {
                    const oldPos = machine.position;
                    // Essayer de garder la m√™me position si possible
                    if (oldPos.y < newGrid.length && oldPos.x < newGrid[oldPos.y].length && 
                        newGrid[oldPos.y][oldPos.x].isUnlocked && !newGrid[oldPos.y][oldPos.x].machine) {
                        newGrid[oldPos.y][oldPos.x].machine = machine;
                        this.state.placedMachines.push(machine);
                    } else {
                        // Trouver une nouvelle position
                        for (let y = 0; y < newGrid.length; y++) {
                            for (let x = 0; x < newGrid[y].length; x++) {
                                if (newGrid[y][x].isUnlocked && !newGrid[y][x].machine) {
                                    machine.position = { x, y };
                                    newGrid[y][x].machine = machine;
                                    this.state.placedMachines.push(machine);
                                    return;
                                }
                            }
                        }
                    }
                });
            },

            // Syst√®me de missions
            initMissions() {
                console.log('üéØ Initialisation du syst√®me de missions...');
                
                // Initialiser les missions quotidiennes
                this.initDailyMissions();
                
                // Initialiser les achievements
                this.initAchievements();
                
                // V√©rifier la connexion quotidienne
                this.checkDailyLogin();
                
                console.log('‚úÖ Missions initialis√©es !');
            },

            initDailyMissions() {
                const today = new Date().toDateString();
                const lastReset = this.state.missions.lastReset;
                
                // R√©initialiser les missions si c'est un nouveau jour
                if (!lastReset || lastReset !== today) {
                    console.log('üîÑ R√©initialisation des missions quotidiennes');
                    
                    // S√©lectionner 3 missions al√©atoires
                    const shuffled = [...GameData.MISSIONS.DAILY_MISSIONS]
                        .sort(() => 0.5 - Math.random())
                        .slice(0, 3);
                    
                    // R√©initialiser les progr√®s
                    shuffled.forEach(mission => {
                        mission.progress = 0;
                        mission.completed = false;
                    });
                    
                    this.state.missions.daily = shuffled;
                    this.state.missions.lastReset = today;
                    this.state.missions.completedToday = 0;
                    
                    this.saveGame();
                }
            },

            initAchievements() {
                if (this.state.missions.achievements.length === 0) {
                    this.state.missions.achievements = JSON.parse(JSON.stringify(GameData.MISSIONS.ACHIEVEMENTS));
                    this.updateAchievementProgress();
                }
            },

            checkDailyLogin() {
                const today = new Date().toDateString();
                const lastLogin = this.state.missions.lastLoginDate;
                
                if (!lastLogin) {
                    // Premier login
                    this.state.missions.streak = 1;
                    this.state.missions.lastLoginDate = today;
                    this.giveDailyLoginReward(1);
                } else if (lastLogin !== today) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    if (lastLogin === yesterday.toDateString()) {
                        // Connexion cons√©cutive
                        this.state.missions.streak++;
                    } else {
                        // Rupture de streak
                        this.state.missions.streak = 1;
                    }
                    
                    this.state.missions.lastLoginDate = today;
                    
                    // Donner la r√©compense du jour
                    const rewardDay = (this.state.missions.streak - 1) % 7 + 1;
                    this.giveDailyLoginReward(rewardDay);
                }
                
                this.updateAchievementProgress('consecutive_login_days', this.state.missions.streak);
            },

            giveDailyLoginReward(day) {
                const reward = GameData.MISSIONS.DAILY_LOGIN_REWARDS[day - 1];
                if (reward) {
                    // Ajouter les ressources
                    Object.entries(reward.reward).forEach(([type, amount]) => {
                        if (type === 'xp') {
                            this.addXp(amount);
                        } else if (type === 'quantum') {
                            this.state.resources[type] = (this.state.resources[type] || 0) + amount;
                        } else {
                            this.state.resources[type] += amount;
                        }
                    });
                    
                    UI.showNotification(`R√©compense quotidienne jour ${day}`, 'success');
                    this.saveGame();
                }
            },

            hookMissionProgress(action, data = {}) {
                // Mettre √† jour les missions quotidiennes
                this.state.missions.daily.forEach(mission => {
                    if (mission.completed) return;
                    
                    if (mission.type === 'place_machines' && action === 'place_machine') {
                        mission.progress++;
                        if (mission.progress >= mission.target) {
                            mission.completed = true;
                            this.completeMission(mission);
                        }
                    } else if (mission.type === 'produce_resource' && action === 'produce_resource' && mission.resource === data.resource) {
                        mission.progress += data.amount || 1;
                        if (mission.progress >= mission.target) {
                            mission.completed = true;
                            this.completeMission(mission);
                        }
                    } else if (mission.type === 'upgrade_machines' && action === 'upgrade_machine') {
                        mission.progress++;
                        if (mission.progress >= mission.target) {
                            mission.completed = true;
                            this.completeMission(mission);
                        }
                    }
                });
                
                // Mettre √† jour les achievements
                this.updateAchievementProgress(action, data);
                
                // Mettre √† jour l'interface
                UI.updateMissionsDisplay();
            },

            updateAchievementProgress(type, data = {}) {
                this.state.missions.achievements.forEach(achievement => {
                    if (achievement.completed) return;
                    
                    if (achievement.type === 'total_machines_placed' && type === 'place_machine') {
                        achievement.progress++;
                        if (achievement.progress >= achievement.target) {
                            achievement.completed = true;
                            this.completeAchievement(achievement);
                        }
                    } else if (achievement.type === 'consecutive_login_days' && type === 'consecutive_login_days') {
                        achievement.progress = data.amount || 1;
                        if (achievement.progress >= achievement.target) {
                            achievement.completed = true;
                            this.completeAchievement(achievement);
                        }
                    }
                });
            },

            completeMission(mission) {
                console.log(`üéâ Mission compl√©t√©e: ${mission.title}`);
                
                // Donner la r√©compense
                Object.entries(mission.reward).forEach(([type, amount]) => {
                    if (type === 'xp') {
                        this.addXp(amount);
                    } else {
                        this.state.resources[type] += amount;
                    }
                });
                
                this.state.missions.completedToday++;
                this.state.missions.totalCompleted++;
                
                // Jouer le son
                if (this.audioSystem) {
                    this.audioSystem.playSound('mission');
                }
                
                UI.showNotification(`Mission "${mission.title}" compl√©t√©e !`, 'success');
                UI.updateResources();
                UI.updateXp();
            },

            completeAchievement(achievement) {
                console.log(`üèÜ Achievement d√©bloqu√©: ${achievement.title}`);
                
                // Donner la r√©compense
                Object.entries(achievement.reward).forEach(([type, amount]) => {
                    if (type === 'xp') {
                        this.addXp(amount);
                    } else if (type === 'quantum') {
                        this.state.resources.quantum = (this.state.resources.quantum || 0) + amount;
                    } else {
                        this.state.resources[type] += amount;
                    }
                });
                
                // Jouer le son
                if (this.audioSystem) {
                    this.audioSystem.playSound('achievement');
                }
                
                UI.showAchievementNotification(achievement);
                UI.updateResources();
                UI.updateXp();
            },

            // Utilitaires de ressources
            getMachineCost(type, level) {
                const def = GameData.MACHINES[type];
                const multiplier = Math.pow(GameData.CONSTANTS.UPGRADE_COST_MULTIPLIER, level - 1);
                
                const cost = {};
                for (const [resource, amount] of Object.entries(def.baseCost)) {
                    cost[resource] = Math.round(amount * multiplier);
                }
                
                return cost;
            },

            getMachineProduction(type, level) {
                const def = GameData.MACHINES[type];
                const base = { ...def.baseProduction };
                const multiplier = Math.pow(GameData.CONSTANTS.UPGRADE_PRODUCTION_MULTIPLIER, level - 1);

                // Appliquer les bonus de recherche
                for (const researchId of this.state.research.completed) {
                    const research = GameData.RESEARCH_TREE.find(r => r.id === researchId);
                    if (research && research.effect.type === 'production_multiplier') {
                        if (research.effect.target === 'all' || research.effect.target === type) {
                            multiplier *= research.effect.value;
                        }
                    }
                }

                for (const resource in base) {
                    base[resource] = Math.round(base[resource] * multiplier);
                }

                return base;
            },

            getMachineConsumption(type, level) {
                const def = GameData.MACHINES[type];
                const base = { ...def.baseConsumption };
                const multiplier = Math.pow(GameData.CONSTANTS.UPGRADE_PRODUCTION_MULTIPLIER, level - 1);

                // Appliquer les r√©ductions de recherche
                for (const researchId of this.state.research.completed) {
                    const research = GameData.RESEARCH_TREE.find(r => r.id === researchId);
                    if (research && research.effect.type === 'consumption_reduction') {
                        if (research.effect.target === 'energy' || research.effect.target === 'all') {
                            if (base.energy) {
                                base.energy = Math.round(base.energy * research.effect.value);
                            }
                        }
                    }
                }

                for (const resource in base) {
                    base[resource] = Math.round(base[resource] * multiplier);
                }

                return base;
            },

            canPlaceMachine(type, position) {
                const def = GameData.MACHINES[type];
                if (def.requiredLevel > this.state.progress.level) {
                    return false;
                }

                const cell = this.state.grid[position.y][position.x];
                if (!cell.isUnlocked || cell.machine) {
                    return false;
                }

                return true;
            },

            hasEnoughResources(required) {
                for (const [resource, amount] of Object.entries(required)) {
                    if (this.state.resources[resource] < amount) {
                        return false;
                    }
                }
                return true;
            },

            addResources(resources) {
                for (const [resource, amount] of Object.entries(resources)) {
                    this.state.resources[resource] += amount;
                }
            },

            deductResources(resources) {
                for (const [resource, amount] of Object.entries(resources)) {
                    this.state.resources[resource] -= amount;
                }
            },

            multiplyResources(resources, multiplier) {
                const result = {};
                for (const [resource, amount] of Object.entries(resources)) {
                    result[resource] = Math.round(amount * multiplier);
                }
                return result;
            },

            // Sauvegarde et chargement
            saveGame() {
                const saveData = {
                    ...this.state,
                    lastSaved: Date.now(),
                    saveVersion: GameData.CONSTANTS.SAVE_VERSION
                };
                
                try {
                    localStorage.setItem(GameData.CONSTANTS.SAVE_KEY, JSON.stringify(saveData));
                    this.state.lastSaved = Date.now();
                    console.log('üíæ Jeu sauvegard√©');
                    
                    // Mettre √† jour l'interface
                    UI.updateLastSaveTime();
                } catch (error) {
                    console.error('Erreur de sauvegarde:', error);
                }
            },

            loadGame() {
                try {
                    const saved = localStorage.getItem(GameData.CONSTANTS.SAVE_KEY);
                    if (saved) {
                        const saveData = JSON.parse(saved);
                        
                        if (saveData.saveVersion === GameData.CONSTANTS.SAVE_VERSION) {
                            // Fusionner avec l'√©tat par d√©faut pour les nouvelles propri√©t√©s
                            this.state = {
                                ...this.state,
                                ...saveData,
                                // S'assurer que les nouvelles propri√©t√©s existent
                                settings: {
                                    ...this.state.settings,
                                    ...(saveData.settings || {})
                                }
                            };
                            console.log('üíæ Jeu charg√© depuis la sauvegarde');
                        }
                    }
                } catch (error) {
                    console.error('Erreur de chargement:', error);
                }
            },

            resetGame() {
                if (confirm('√ätes-vous s√ªr de vouloir r√©initialiser le jeu ? Toute votre progression sera perdue.')) {
                    localStorage.removeItem(GameData.CONSTANTS.SAVE_KEY);
                    location.reload();
                }
            },

            // Gestion des param√®tres
            updateSettings(settings) {
                this.state.settings = { ...this.state.settings, ...settings };
                
                // Mettre √† jour l'audio
                if (this.audioSystem) {
                    this.audioSystem.updateSettings(this.state.settings);
                }
                
                this.saveGame();
            },

            // Utilitaires d'affichage
            formatReward(reward) {
                return Object.entries(reward)
                    .map(([type, amount]) => {
                        const icons = {
                            money: 'üí∞',
                            energy: '‚ö°',
                            matter: 'üß±',
                            research: 'üß™',
                            xp: '‚≠ê',
                            quantum: 'üîÆ'
                        };
                        return `${icons[type] || ''} ${amount} ${type === 'xp' ? 'XP' : ''}`;
                    })
                    .join(' ');
            }
        };

        // =============================================================================
        // SYST√àMES
        // =============================================================================
        class EventSystem {
            constructor(game) {
                this.game = game;
                this.activeEvents = [];
                this.lastEventTime = Date.now();
            }

            update() {
                // V√©rifier les √©v√©nements expir√©s
                const now = Date.now();
                for (let i = this.activeEvents.length - 1; i >= 0; i--) {
                    const event = this.activeEvents[i];
                    if (now >= event.endTime) {
                        event.active = false;
                        this.activeEvents.splice(i, 1);
                        UI.showNotification(`√âv√©nement "${event.name}" termin√©`, 'info');
                    }
                }

                // Mettre √† jour l'interface
                if (this.activeEvents.length > 0) {
                    UI.updateEventDisplay(this.activeEvents[0]);
                } else {
                    UI.hideEventDisplay();
                }

                // V√©rifier si un nouvel √©v√©nement doit appara√Ætre
                this.checkForNewEvent();
            }

            checkForNewEvent() {
                const now = Date.now();
                if (now - this.lastEventTime < GameData.CONSTANTS.EVENT_COOLDOWN * 1000) {
                    return;
                }

                // Chance d'apparition d'√©v√©nement
                if (Math.random() < GameData.CONSTANTS.EVENT_CHANCE) {
                    this.triggerRandomEvent();
                }
            }

            triggerRandomEvent() {
                const availableEvents = Object.values(GameData.EVENTS).filter(event => 
                    event.minLevel <= this.game.state.progress.level
                );

                if (availableEvents.length === 0) return;

                const event = availableEvents[Math.floor(Math.random() * availableEvents.length)];
                const eventData = {
                    ...event,
                    startTime: Date.now(),
                    endTime: Date.now() + (event.duration * 1000),
                    active: true
                };

                this.activeEvents.push(eventData);
                this.lastEventTime = Date.now();

                // Jouer le son
                if (this.game.audioSystem) {
                    this.game.audioSystem.playSound('event');
                }

                // Afficher la notification
                UI.showEventNotification(eventData);

                // Mettre √† jour les statistiques
                this.game.state.stats.eventsCompleted++;

                console.log(`√âv√©nement d√©clench√©: ${event.name}`);
            }

            getActiveEventMultiplier() {
                let multiplier = 1.0;
                this.activeEvents.forEach(event => {
                    if (event.effect.production_multiplier) {
                        multiplier *= event.effect.production_multiplier;
                    }
                });
                return multiplier;
            }
        }

        class PrestigeSystem {
            constructor(game) {
                this.game = game;
                this.quantumCores = game.state.prestige?.quantumCores || 0;
                this.currentDimension = game.state.prestige?.currentDimension || 'alpha';
                this.unlockedDimensions = game.state.prestige?.unlockedDimensions || ['alpha'];
                this.dimensionBonuses = {};
                this.calculateDimensionBonuses();
            }

            canPrestige() {
                const currentMoney = this.game.state.resources.money;
                const prestigeCost = this.getPrestigeCost();
                
                return currentMoney >= prestigeCost && 
                       this.game.state.progress.level >= 5;
            }

            getPrestigeCost() {
                return GameData.CONSTANTS.PRESTIGE_BASE_COST * 
                       Math.pow(GameData.CONSTANTS.PRESTIGE_COST_MULTIPLIER, this.quantumCores);
            }

            prestige() {
                if (!this.canPrestige()) return false;

                const cost = this.getPrestigeCost();
                
                // D√©duire le co√ªt
                this.game.state.resources.money -= cost;
                
                // Gagner un c≈ìur quantique
                this.quantumCores++;
                this.game.state.resources.quantum = (this.game.state.resources.quantum || 0) + 1;
                
                // R√©initialiser le jeu
                this.resetForPrestige();
                
                // Jouer le son
                if (this.game.audioSystem) {
                    this.game.audioSystem.playSound('prestige');
                }
                
                return true;
            }

            resetForPrestige() {
                // Sauvegarder certaines statistiques
                const statsToKeep = {
                    quantumCores: this.quantumCores,
                    unlockedDimensions: this.unlockedDimensions,
                    currentDimension: this.currentDimension,
                    totalPlayTime: this.game.state.stats.playTime,
                    prestigeCount: (this.game.state.stats.prestigeCount || 0) + 1
                };

                // R√©initialiser l'√©tat du jeu
                this.game.state = {
                    version: GameData.CONSTANTS.SAVE_VERSION,
                    resources: {
                        energy: 10 + (this.quantumCores * 5),
                        matter: 0,
                        money: 50 + (this.quantumCores * 20),
                        research: 0,
                        quantum: this.quantumCores
                    },
                    progress: {
                        level: 1,
                        currentXp: 0,
                        totalXp: this.game.state.progress.totalXp
                    },
                    grid: [],
                    placedMachines: [],
                    research: {
                        completed: [],
                        current: null,
                        progress: 0
                    },
                    missions: this.game.state.missions,
                    quests: this.game.state.quests,
                    events: this.game.state.events,
                    prestige: {
                        quantumCores: this.quantumCores,
                        currentDimension: this.currentDimension,
                        unlockedDimensions: this.unlockedDimensions
                    },
                    settings: this.game.state.settings,
                    stats: {
                        machinesPlaced: 0,
                        totalProduced: { energy: 0, matter: 0, money: 0, research: 0 },
                        playTime: statsToKeep.totalPlayTime,
                        prestigeCount: statsToKeep.prestigeCount,
                        chainsCreated: this.game.state.stats.chainsCreated || 0,
                        eventsCompleted: this.game.state.stats.eventsCompleted || 0
                    },
                    lastTick: Date.now(),
                    tutorialCompleted: true,
                    lastSaved: Date.now()
                };

                // R√©initialiser la grille
                this.game.initGrid();
                
                // R√©initialiser les missions quotidiennes
                this.game.initDailyMissions();
                
                // Calculer les nouveaux bonus
                this.calculateDimensionBonuses();
            }

            switchDimension(dimensionId) {
                if (!this.unlockedDimensions.includes(dimensionId)) return false;
                
                this.currentDimension = dimensionId;
                this.calculateDimensionBonuses();
                
                this.game.state.prestige.currentDimension = dimensionId;
                
                return true;
            }

            calculateDimensionBonuses() {
                const dimension = GameData.DIMENSIONS.find(d => d.id === this.currentDimension);
                if (!dimension) return;

                this.dimensionBonuses = { ...dimension.bonus };
                
                const quantumBonus = 1 + (this.quantumCores * GameData.CONSTANTS.QUANTUM_CORE_BONUS);
                Object.keys(this.dimensionBonuses).forEach(key => {
                    this.dimensionBonuses[key] *= quantumBonus;
                });
            }

            getDimensionBonus(machineType) {
                let bonus = 1.0;
                
                if (this.dimensionBonuses.production) {
                    bonus *= this.dimensionBonuses.production;
                }
                
                if (machineType === 'generator' && this.dimensionBonuses.generator_efficiency) {
                    bonus *= this.dimensionBonuses.generator_efficiency;
                }
                
                if (machineType === 'extractor' && this.dimensionBonuses.extractor_efficiency) {
                    bonus *= this.dimensionBonuses.extractor_efficiency;
                }
                
                if (machineType === 'factory' && this.dimensionBonuses.factory_efficiency) {
                    bonus *= this.dimensionBonuses.factory_efficiency;
                }
                
                return bonus;
            }

            getGlobalBonus() {
                return {
                    production: this.dimensionBonuses.production || 1,
                    energy_efficiency: this.dimensionBonuses.energy_efficiency || 1,
                    matter_production: this.dimensionBonuses.matter_production || 1,
                    research_speed: this.dimensionBonuses.research_speed || 1,
                    chain_bonus: this.dimensionBonuses.chain_bonus_multiplier || 1,
                    all_production: this.dimensionBonuses.all_production || 1
                };
            }
        }

        class ChainSystem {
            constructor(game) {
                this.game = game;
                this.connections = [];
                this.activeChains = [];
                this.chainBonus = GameData.CONSTANTS.CHAIN_BONUS_BASE;
                this.machineConnections = new Map();
            }

            updateConnections() {
                this.connections = [];
                this.activeChains = [];
                this.machineConnections.clear();
                
                const machines = this.game.state.placedMachines;
                
                // Trouver toutes les connexions valides
                for (let i = 0; i < machines.length; i++) {
                    for (let j = i + 1; j < machines.length; j++) {
                        const machine1 = machines[i];
                        const machine2 = machines[j];
                        
                        if (this.canConnect(machine1, machine2)) {
                            const connection = {
                                from: machine1.position,
                                to: machine2.position,
                                type: 'valid',
                                bonus: this.getConnectionBonus(machine1.type, machine2.type)
                            };
                            
                            this.connections.push(connection);
                            
                            // Enregistrer les connexions par machine
                            if (!this.machineConnections.has(machine1.id)) {
                                this.machineConnections.set(machine1.id, []);
                            }
                            if (!this.machineConnections.has(machine2.id)) {
                                this.machineConnections.set(machine2.id, []);
                            }
                            
                            this.machineConnections.get(machine1.id).push(machine2.id);
                            this.machineConnections.get(machine2.id).push(machine1.id);
                        }
                    }
                }
                
                // Identifier les cha√Ænes actives
                this.identifyChains();
                
                // Mettre √† jour l'affichage
                UI.drawConnections();
                UI.updateChainDisplay();
            }

            canConnect(machine1, machine2) {
                // V√©rifier la distance
                const distance = Math.abs(machine1.position.x - machine2.position.x) + 
                                Math.abs(machine1.position.y - machine2.position.y);
                
                if (distance > GameData.CONSTANTS.CHAIN_MAX_DISTANCE) {
                    return false;
                }
                
                // V√©rifier si les machines peuvent se connecter
                const def1 = GameData.MACHINES[machine1.type];
                const def2 = GameData.MACHINES[machine2.type];
                
                if (def1.chainBonus && def1.chainBonus.connectsTo.includes(machine2.type)) {
                    return true;
                }
                
                if (def2.chainBonus && def2.chainBonus.connectsTo.includes(machine1.type)) {
                    return true;
                }
                
                return false;
            }

            getConnectionBonus(type1, type2) {
                const def1 = GameData.MACHINES[type1];
                const def2 = GameData.MACHINES[type2];
                
                if (def1.chainBonus && def1.chainBonus.connectsTo.includes(type2)) {
                    return def1.chainBonus.bonus;
                }
                
                if (def2.chainBonus && def2.chainBonus.connectsTo.includes(type1)) {
                    return def2.chainBonus.bonus;
                }
                
                return 0;
            }

            identifyChains() {
                const visited = new Set();
                const machines = this.game.state.placedMachines;
                
                machines.forEach(machine => {
                    if (!visited.has(machine.id)) {
                        const chain = this.findConnectedMachines(machine, visited);
                        if (chain.length >= 2) {
                            this.activeChains.push(chain);
                            this.game.state.stats.chainsCreated++;
                        }
                    }
                });
            }

            findConnectedMachines(startMachine, visited) {
                const queue = [startMachine];
                const chain = [];
                
                while (queue.length > 0) {
                    const machine = queue.shift();
                    
                    if (visited.has(machine.id)) continue;
                    
                    visited.add(machine.id);
                    chain.push(machine);
                    
                    // Trouver les machines connect√©es
                    const connections = this.machineConnections.get(machine.id) || [];
                    connections.forEach(connectedId => {
                        const connectedMachine = this.game.state.placedMachines.find(m => m.id === connectedId);
                        if (connectedMachine && !visited.has(connectedMachine.id)) {
                            queue.push(connectedMachine);
                        }
                    });
                }
                
                return chain;
            }

            getMachineBonus(machineId) {
                let bonus = 0;
                
                this.activeChains.forEach(chain => {
                    const machineInChain = chain.find(m => m.id === machineId);
                    if (machineInChain) {
                        bonus += this.chainBonus * (chain.length - 1);
                    }
                });
                
                return bonus;
            }

            calculateChainBonus() {
                let totalBonus = 1;
                
                this.activeChains.forEach(chain => {
                    if (chain.length >= 2) {
                        totalBonus += this.chainBonus * (chain.length - 1);
                    }
                });
                
                return totalBonus;
            }
        }

        class QuestSystem {
            constructor(game) {
                this.game = game;
                this.currentChapter = game.state.quests?.currentChapter || 1;
                this.completedQuests = game.state.quests?.completedQuests || [];
                this.currentQuest = game.state.quests?.currentQuest || 'prologue_1';
                this.questProgress = game.state.quests?.questProgress || {};
                this.initQuests();
            }

            initQuests() {
                if (this.game.state.quests) {
                    this.currentChapter = this.game.state.quests.currentChapter;
                    this.completedQuests = this.game.state.quests.completedQuests || [];
                    this.currentQuest = this.game.state.quests.currentQuest;
                    this.questProgress = this.game.state.quests.questProgress || {};
                }
                
                if (!this.getCurrentQuest()) {
                    this.currentQuest = 'prologue_1';
                }
            }

            getCurrentQuest() {
                return this.getQuestById(this.currentQuest);
            }

            getQuestById(questId) {
                for (const chapter of GameData.STORY_QUESTS) {
                    for (const quest of chapter.quests) {
                        if (quest.id === questId) {
                            return quest;
                        }
                    }
                }
                return null;
            }

            completeQuest(questId) {
                if (this.completedQuests.includes(questId)) return;
                
                const quest = this.getQuestById(questId);
                if (!quest) return;
                
                // Ajouter aux qu√™tes compl√©t√©es
                this.completedQuests.push(questId);
                
                // Donner la r√©compense
                if (quest.reward) {
                    Object.entries(quest.reward).forEach(([type, amount]) => {
                        if (type === 'xp') {
                            this.game.addXp(amount);
                        } else if (type === 'quantum') {
                            this.game.state.resources.quantum = (this.game.state.resources.quantum || 0) + amount;
                        } else {
                            this.game.state.resources[type] += amount;
                        }
                    });
                }
                
                // Trouver la prochaine qu√™te
                this.advanceToNextQuest(questId);
                
                // Jouer le son
                if (this.game.audioSystem) {
                    this.game.audioSystem.playSound('quest');
                }
                
                // Notifier le joueur
                UI.showQuestNotification(quest);
                
                this.saveQuests();
            }

            advanceToNextQuest(completedQuestId) {
                // Chercher la qu√™te suivante dans le m√™me chapitre
                const currentChapter = GameData.STORY_QUESTS.find(c => 
                    c.quests.some(q => q.id === completedQuestId)
                );
                
                if (!currentChapter) return;
                
                const currentIndex = currentChapter.quests.findIndex(q => q.id === completedQuestId);
                if (currentIndex < currentChapter.quests.length - 1) {
                    // Passer √† la qu√™te suivante dans le chapitre
                    this.currentQuest = currentChapter.quests[currentIndex + 1].id;
                } else {
                    // Passer au chapitre suivant
                    const nextChapter = GameData.STORY_QUESTS.find(c => c.chapter === currentChapter.chapter + 1);
                    if (nextChapter && nextChapter.quests.length > 0) {
                        this.currentChapter = nextChapter.chapter;
                        this.currentQuest = nextChapter.quests[0].id;
                    }
                }
            }

            getChapterProgress() {
                const currentChapter = GameData.STORY_QUESTS.find(c => c.chapter === this.currentChapter);
                if (!currentChapter) return { completed: 0, total: 0, percent: 0 };
                
                const completed = currentChapter.quests.filter(q => 
                    this.completedQuests.includes(q.id)
                ).length;
                
                const total = currentChapter.quests.length;
                const percent = total > 0 ? (completed / total) * 100 : 0;
                
                return { completed, total, percent };
            }

            saveQuests() {
                this.game.state.quests = {
                    currentChapter: this.currentChapter,
                    completedQuests: this.completedQuests,
                    currentQuest: this.currentQuest,
                    questProgress: this.questProgress
                };
                
                this.game.saveGame();
            }
        }

        class AudioSystem {
            constructor(game) {
                this.game = game;
                this.audioContext = null;
                this.music = null;
                this.sounds = new Map();
                this.musicEnabled = true;
                this.sfxEnabled = true;
                this.masterVolume = 0.8;
                this.init();
            }

            init() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.loadSounds();
                    this.startMusic();
                } catch (error) {
                    console.warn('Audio non support√©:', error);
                }
            }

            loadSounds() {
                // Sons de base g√©n√©r√©s par synth√®se
                this.createSound('click', 200, 'sine', 0.1);
                this.createSound('place', 400, 'square', 0.2);
                this.createSound('upgrade', 600, 'sawtooth', 0.3);
                this.createSound('sell', 300, 'triangle', 0.2);
                this.createSound('research', 800, 'sine', 0.4);
                this.createSound('complete', 1000, 'square', 0.5);
                this.createSound('mission', 1200, 'sawtooth', 0.3);
                this.createSound('achievement', 1500, 'sine', 0.6);
                this.createSound('quest', 900, 'triangle', 0.4);
                this.createSound('event', 700, 'square', 0.5);
                this.createSound('prestige', 2000, 'sawtooth', 0.7);
                this.createSound('levelup', 1800, 'sine', 0.6);
            }

            createSound(name, frequency, type, duration) {
                if (!this.audioContext) return;
                
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                oscillator.type = type;
                
                gainNode.gain.setValueAtTime(0.3 * this.masterVolume, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
                
                this.sounds.set(name, { oscillator, gainNode, duration });
            }

            startMusic() {
                if (!this.audioContext || !this.musicEnabled) return;
                
                // Musique d'ambiance simple
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(440, this.audioContext.currentTime);
                
                gainNode.gain.setValueAtTime(0.1 * this.masterVolume, this.audioContext.currentTime);
                
                oscillator.start();
                oscillator.stop(this.audioContext.currentTime + 3600); // 1 heure
                
                this.music = { oscillator, gainNode };
            }

            playSound(name) {
                if (!this.audioContext || !this.sfxEnabled) return;
                
                const sound = this.sounds.get(name);
                if (sound) {
                    // Cr√©er une nouvelle instance du son
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    // Copier les param√®tres du son original
                    oscillator.type = sound.oscillator.type;
                    oscillator.frequency.setValueAtTime(sound.oscillator.frequency.value, this.audioContext.currentTime);
                    
                    gainNode.gain.setValueAtTime(0.3 * this.masterVolume, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + sound.duration);
                    
                    oscillator.start();
                    oscillator.stop(this.audioContext.currentTime + sound.duration);
                }
            }

            updateSettings(settings) {
                this.masterVolume = settings.masterVolume / 100;
                this.musicEnabled = settings.musicEnabled;
                this.sfxEnabled = settings.sfxEnabled;
                
                // Mettre √† jour le volume de la musique
                if (this.music) {
                    this.music.gainNode.gain.setValueAtTime(
                        this.musicEnabled ? 0.1 * this.masterVolume : 0,
                        this.audioContext.currentTime
                    );
                }
                
                // Mettre √† jour l'indicateur audio
                UI.updateAudioIndicator();
            }

            toggleMute() {
                this.masterVolume = this.masterVolume > 0 ? 0 : 0.8;
                this.updateSettings({
                    masterVolume: this.masterVolume * 100
                });
            }
        }

        class AnimationSystem {
            constructor(game) {
                this.game = game;
                this.particles = [];
                this.effects = [];
            }

            update(deltaTime) {
                // Mettre √† jour les particules
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const particle = this.particles[i];
                    particle.life -= deltaTime;
                    
                    if (particle.life <= 0) {
                        this.particles.splice(i, 1);
                        if (particle.element && particle.element.parentNode) {
                            particle.element.parentNode.removeChild(particle.element);
                        }
                    } else {
                        particle.x += particle.vx * deltaTime;
                        particle.y += particle.vy * deltaTime;
                        particle.element.style.transform = `translate(${particle.x}px, ${particle.y}px) scale(${particle.life})`;
                        particle.element.style.opacity = particle.life;
                    }
                }
                
                // Mettre √† jour les effets
                for (let i = this.effects.length - 1; i >= 0; i--) {
                    const effect = this.effects[i];
                    effect.progress += deltaTime / effect.duration;
                    
                    if (effect.progress >= 1) {
                        this.effects.splice(i, 1);
                        if (effect.element && effect.element.parentNode) {
                            effect.element.parentNode.removeChild(effect.element);
                        }
                    } else {
                        if (effect.type === 'float') {
                            effect.element.style.transform = `translateY(${-50 * effect.progress}px)`;
                            effect.element.style.opacity = 1 - effect.progress;
                        }
                    }
                }
            }

            createParticle(x, y, type) {
                if (!this.game.state.settings.animationsEnabled) return;
                
                const particle = document.createElement('div');
                particle.className = `particle ${type}-particle`;
                particle.style.left = `${x}px`;
                particle.style.top = `${y}px`;
                particle.style.width = '10px';
                particle.style.height = '10px';
                
                document.body.appendChild(particle);
                
                this.particles.push({
                    element: particle,
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 100,
                    vy: (Math.random() - 0.5) * 100 - 50,
                    life: 1 + Math.random() * 2,
                    type: type
                });
            }

            createProductionEffect(position, production) {
                if (!this.game.state.settings.animationsEnabled) return;
                
                const gridContainer = document.getElementById('game-grid');
                const cell = gridContainer.querySelector(`[data-x="${position.x}"][data-y="${position.y}"]`);
                
                if (!cell) return;
                
                const rect = cell.getBoundingClientRect();
                const x = rect.left + rect.width / 2;
                const y = rect.top + rect.height / 2;
                
                // Cr√©er des particules pour chaque ressource produite
                Object.entries(production).forEach(([resource, amount]) => {
                    if (amount > 0) {
                        const type = this.getParticleType(resource);
                        for (let i = 0; i < Math.min(amount, 5); i++) {
                            setTimeout(() => {
                                this.createParticle(x, y, type);
                            }, i * 100);
                        }
                        
                        // Cr√©er un effet de texte
                        this.createTextEffect(x, y, `+${Math.round(amount)}`, resource);
                    }
                });
            }

            createTextEffect(x, y, text, resource) {
                const effect = document.createElement('div');
                effect.className = 'production-effect';
                effect.textContent = text;
                effect.style.left = `${x}px`;
                effect.style.top = `${y}px`;
                
                // Couleur bas√©e sur la ressource
                const colors = {
                    energy: '#00ffaa',
                    matter: '#ffaa00',
                    money: '#00ff55',
                    research: '#aa00ff'
                };
                effect.style.color = colors[resource] || '#ffffff';
                
                document.body.appendChild(effect);
                
                this.effects.push({
                    element: effect,
                    type: 'float',
                    progress: 0,
                    duration: 1
                });
            }

            getParticleType(resource) {
                const types = {
                    energy: 'energy',
                    matter: 'matter',
                    money: 'quantum',
                    research: 'research'
                };
                return types[resource] || 'quantum';
            }

            createRipple(x, y, color = 'rgba(0, 170, 255, 0.5)') {
                if (!this.game.state.settings.animationsEnabled) return;
                
                const ripple = document.createElement('div');
                ripple.style.position = 'fixed';
                ripple.style.left = `${x}px`;
                ripple.style.top = `${y}px`;
                ripple.style.width = '0px';
                ripple.style.height = '0px';
                ripple.style.borderRadius = '50%';
                ripple.style.backgroundColor = color;
                ripple.style.transform = 'translate(-50%, -50%)';
                ripple.style.pointerEvents = 'none';
                ripple.style.zIndex = '1000';
                
                document.body.appendChild(ripple);
                
                // Animation
                const duration = 1000;
                const startTime = Date.now();
                
                const animate = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    const size = progress * 200;
                    ripple.style.width = `${size}px`;
                    ripple.style.height = `${size}px`;
                    ripple.style.opacity = 1 - progress;
                    
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        document.body.removeChild(ripple);
                    }
                };
                
                animate();
            }
        }

        // =============================================================================
        // INTERFACE UTILISATEUR
        // =============================================================================
        const UI = {
            // Initialisation
            init() {
                console.log('üé® Initialisation de l\'interface...');
                
                // Initialiser la grille
                this.initGrid();
                
                // Initialiser les connexions
                this.initConnections();
                
                // Initialiser les boutons
                this.initButtons();
                
                // Initialiser le menu contextuel
                this.initContextMenu();
                
                // Initialiser le s√©lecteur de machines
                this.initMachineSelector();
                
                // Initialiser l'arbre de recherche
                this.initResearch();
                
                // Initialiser l'interface des missions
                this.initMissionsUI();
                
                // Initialiser le syst√®me de prestige
                this.initPrestige();
                
                // Initialiser les param√®tres
                this.initSettings();
                
                // Initialiser l'audio
                this.initAudio();
                
                // Mettre √† jour l'affichage
                this.updateResources();
                this.updateXp();
                this.updateLevel();
                this.updateAudioIndicator();
                
                console.log('‚úÖ Interface initialis√©e !');
            },

            // Grille de jeu
            initGrid() {
                this.updateGrid();
            },

            updateGrid() {
                const gridContainer = document.getElementById('game-grid');
                const { grid } = Game.state;
                
                if (!grid || grid.length === 0) return;
                
                const width = grid[0].length;
                const height = grid.length;
                
                // Configuration de la grille CSS
                gridContainer.style.gridTemplateColumns = `repeat(${width}, 1fr)`;
                gridContainer.style.gridTemplateRows = `repeat(${height}, 1fr)`;
                
                // Nettoyer la grille
                gridContainer.innerHTML = '';
                
                // Cr√©er les cellules
                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        const cellData = grid[y][x];
                        const cell = this.createGridCell(x, y, cellData);
                        gridContainer.appendChild(cell);
                    }
                }
                
                // Mettre √† jour les connexions
                setTimeout(() => this.drawConnections(), 100);
            },

            createGridCell(x, y, cellData) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.dataset.x = x;
                cell.dataset.y = y;
                
                // V√©rifier si la cellule est d√©bloqu√©e
                if (!cellData.isUnlocked) {
                    cell.classList.add('locked');
                }
                
                // Ajouter la machine si pr√©sente
                if (cellData.machine) {
                    this.addMachineToCell(cell, cellData.machine);
                    
                    // V√©rifier si la machine fait partie d'une cha√Æne
                    if (Game.chainSystem) {
                        const isInChain = Game.chainSystem.activeChains.some(chain =>
                            chain.some(m => m.id === cellData.machine.id)
                        );
                        if (isInChain) {
                            cell.classList.add('connected');
                        }
                    }
                }
                
                // √âv√©nements
                cell.addEventListener('click', (e) => this.onCellClick(e, x, y));
                cell.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    this.showContextMenu(e, x, y);
                });
                
                return cell;
            },

            addMachineToCell(cell, machine) {
                cell.classList.add('occupied');
                
                const def = GameData.MACHINES[machine.type];
                const content = document.createElement('div');
                content.className = 'machine-content';
                content.innerHTML = `
                    <span class="machine-icon" style="color: ${def.color}">${def.icon}</span>
                    <span class="machine-level">${machine.level}</span>
                `;
                
                // Ajouter des classes pour l'√©tat
                if (machine.isActive) {
                    cell.classList.add('active');
                } else {
                    cell.classList.add('inactive');
                }
                
                cell.appendChild(content);
            },

            onCellClick(event, x, y) {
                const cell = Game.state.grid[y][x];
                
                if (!cell.isUnlocked) {
                    this.showNotification('Cellule verrouill√©e', 'error');
                    return;
                }
                
                if (cell.machine) {
                    // Afficher les infos de la machine
                    this.showMachineInfo(cell.machine);
                } else {
                    // Ouvrir le s√©lecteur de machines
                    this.openMachineSelector(x, y);
                }
            },

            // Syst√®me de connexions
            initConnections() {
                this.connectionCanvas = document.getElementById('connection-canvas');
                this.connectionCtx = this.connectionCanvas.getContext('2d');
                
                // Redimensionner le canvas
                window.addEventListener('resize', () => this.resizeCanvas());
                this.resizeCanvas();
            },

            resizeCanvas() {
                const gridContainer = document.querySelector('.grid-container');
                if (!gridContainer) return;
                
                const rect = gridContainer.getBoundingClientRect();
                this.connectionCanvas.width = rect.width;
                this.connectionCanvas.height = rect.height;
                this.connectionCanvas.style.width = rect.width + 'px';
                this.connectionCanvas.style.height = rect.height + 'px';
                
                this.drawConnections();
            },

            drawConnections() {
                if (!this.connectionCtx || !Game.chainSystem) return;
                
                // Effacer le canvas
                this.connectionCtx.clearRect(0, 0, this.connectionCanvas.width, this.connectionCanvas.height);
                
                // Dessiner les connexions
                Game.chainSystem.connections.forEach(connection => {
                    this.drawConnection(connection);
                });
            },

            drawConnection(connection) {
                const fromCell = document.querySelector(`.grid-cell[data-x="${connection.from.x}"][data-y="${connection.from.y}"]`);
                const toCell = document.querySelector(`.grid-cell[data-x="${connection.to.x}"][data-y="${connection.to.y}"]`);
                
                if (!fromCell || !toCell) return;
                
                const fromRect = fromCell.getBoundingClientRect();
                const toRect = toCell.getBoundingClientRect();
                const canvasRect = this.connectionCanvas.getBoundingClientRect();
                
                // Calculer les positions relatives au canvas
                const fromX = fromRect.left + fromRect.width / 2 - canvasRect.left;
                const fromY = fromRect.top + fromRect.height / 2 - canvasRect.top;
                const toX = toRect.left + toRect.width / 2 - canvasRect.left;
                const toY = toRect.top + toRect.height / 2 - canvasRect.top;
                
                // Configurer le style de la ligne
                this.connectionCtx.strokeStyle = 'rgba(0, 255, 255, 0.7)';
                this.connectionCtx.lineWidth = 3;
                this.connectionCtx.lineCap = 'round';
                
                // Dessiner la ligne
                this.connectionCtx.beginPath();
                this.connectionCtx.moveTo(fromX, fromY);
                this.connectionCtx.lineTo(toX, toY);
                this.connectionCtx.stroke();
                
                // Ajouter un effet de glow
                this.connectionCtx.shadowColor = 'rgba(0, 255, 255, 0.5)';
                this.connectionCtx.shadowBlur = 10;
                this.connectionCtx.stroke();
                this.connectionCtx.shadowBlur = 0;
            },

            updateChainDisplay() {
                const indicator = document.getElementById('chain-indicator');
                const bonusElement = document.getElementById('chain-bonus');
                
                if (!Game.chainSystem || Game.chainSystem.activeChains.length === 0) {
                    indicator.style.display = 'none';
                    return;
                }
                
                // Calculer le bonus total
                const totalBonus = Game.chainSystem.calculateChainBonus();
                const bonusPercentage = Math.round((totalBonus - 1) * 100);
                
                // Mettre √† jour l'affichage
                bonusElement.textContent = `+${bonusPercentage}%`;
                indicator.style.display = 'block';
            },

            // Menu contextuel
            initContextMenu() {
                this.contextMenu = document.getElementById('context-menu');
                this.contextActions = document.getElementById('context-actions');
                this.contextClose = document.getElementById('context-close');
                
                this.contextClose.addEventListener('click', () => {
                    this.contextMenu.style.display = 'none';
                });
            },

            showContextMenu(event, x, y) {
                event.preventDefault();
                
                const cell = Game.state.grid[y][x];
                if (!cell.isUnlocked || !cell.machine) return;
                
                const machine = cell.machine;
                const def = GameData.MACHINES[machine.type];
                
                // Positionner le menu
                const menuWidth = 280;
                const menuHeight = 200;
                let left = event.clientX;
                let top = event.clientY;
                
                // Ajuster si le menu d√©passe de l'√©cran
                if (left + menuWidth > window.innerWidth) {
                    left = window.innerWidth - menuWidth - 10;
                }
                if (top + menuHeight > window.innerHeight) {
                    top = window.innerHeight - menuHeight - 10;
                }
                
                this.contextMenu.style.left = `${left}px`;
                this.contextMenu.style.top = `${top}px`;
                
                // Nettoyer les actions pr√©c√©dentes
                this.contextActions.innerHTML = '';
                
                // Ajouter les actions
                const actions = this.getMachineActions(machine, x, y);
                actions.forEach(action => {
                    const actionDiv = document.createElement('div');
                    actionDiv.className = `context-action ${action.disabled ? 'action-disabled' : ''}`;
                    
                    actionDiv.innerHTML = `
                        <span class="action-icon">${action.icon}</span>
                        <span class="action-text">${action.text}</span>
                        ${action.cost ? `<span class="action-cost">${this.formatCost(action.cost)}</span>` : ''}
                    `;
                    
                    if (!action.disabled) {
                        actionDiv.addEventListener('click', () => {
                            action.action();
                            this.contextMenu.style.display = 'none';
                        });
                    }
                    
                    this.contextActions.appendChild(actionDiv);
                });
                
                this.contextMenu.style.display = 'block';
            },

            getMachineActions(machine, x, y) {
                const def = GameData.MACHINES[machine.type];
                const actions = [];
                
                // Informations
                actions.push({
                    icon: 'üìä',
                    text: 'Informations',
                    action: () => this.showMachineInfo(machine),
                    disabled: false
                });
                
                // Am√©lioration
                const upgradeCost = Game.getMachineCost(machine.type, machine.level + 1);
                const canUpgrade = machine.level < 5 && Game.hasEnoughResources(upgradeCost);
                
                actions.push({
                    icon: '‚¨ÜÔ∏è',
                    text: `Am√©liorer (Niv. ${machine.level + 1})`,
                    action: () => Game.upgradeMachine(machine.id),
                    cost: machine.level < 5 ? upgradeCost : null,
                    disabled: !canUpgrade
                });
                
                // Vente
                actions.push({
                    icon: 'üí∞',
                    text: 'Vendre',
                    action: () => Game.sellMachine(machine.id),
                    disabled: false
                });
                
                return actions;
            },

            // S√©lecteur de machines
            initMachineSelector() {
                this.machineSelector = document.getElementById('machine-selector');
                this.machineList = document.getElementById('machine-list');
                this.selectorClose = document.getElementById('selector-close');
                
                this.selectorClose.addEventListener('click', () => {
                    this.closeMachineSelector();
                });
            },

            openMachineSelector(x, y) {
                this.selectedPosition = { x, y };
                
                // Nettoyer la liste
                this.machineList.innerHTML = '';
                
                // Ajouter les machines disponibles
                const unlockedMachines = this.getUnlockedMachines();
                
                if (unlockedMachines.length === 0) {
                    this.machineList.innerHTML = `
                        <div class="no-machines">
                            <p>üîí Aucune machine disponible</p>
                            <p>Montez de niveau pour d√©bloquer de nouvelles machines</p>
                        </div>
                    `;
                } else {
                    unlockedMachines.forEach(machineType => {
                        const machineCard = this.createMachineCard(machineType, x, y);
                        this.machineList.appendChild(machineCard);
                    });
                }
                
                this.machineSelector.style.display = 'block';
            },

            closeMachineSelector() {
                this.machineSelector.style.display = 'none';
                this.selectedPosition = null;
            },

            createMachineCard(machineType, x, y) {
                const def = GameData.MACHINES[machineType];
                const cost = Game.getMachineCost(machineType, 1);
                const canAfford = Game.hasEnoughResources(cost);
                const canPlace = Game.canPlaceMachine(machineType, { x, y });
                const isUnlocked = def.requiredLevel <= Game.state.progress.level;
                
                const card = document.createElement('div');
                card.className = `machine-card ${isUnlocked && canAfford && canPlace ? '' : 'disabled'}`;
                card.innerHTML = `
                    <div class="machine-icon-large" style="color: ${def.color}">${def.icon}</div>
                    <div class="machine-name">${def.name}</div>
                    <div class="machine-desc">${def.description}</div>
                    <div class="machine-cost">${this.formatCost(cost)}</div>
                    ${!isUnlocked ? 
                        `<div class="machine-level-req">Niveau ${def.requiredLevel} requis</div>` : ''}
                `;
                
                if (isUnlocked && canAfford && canPlace) {
                    card.addEventListener('click', () => {
                        if (Game.placeMachine(machineType, { x, y })) {
                            this.closeMachineSelector();
                        }
                    });
                }
                
                return card;
            },

            getUnlockedMachines() {
                return Object.keys(GameData.MACHINES).filter(type => {
                    const def = GameData.MACHINES[type];
                    return def.requiredLevel <= Game.state.progress.level;
                });
            },

            // Syst√®me de recherche
            initResearch() {
                this.researchOverlay = document.getElementById('research-overlay');
                this.researchTree = document.getElementById('research-tree');
                this.researchClose = document.getElementById('research-close');
                
                this.researchClose.addEventListener('click', () => {
                    this.researchOverlay.style.display = 'none';
                });
            },

            showResearchOverlay() {
                // Mettre √† jour les points de recherche disponibles
                const researchValue = document.getElementById('current-research');
                researchValue.textContent = Math.floor(Game.state.resources.research);
                
                // Nettoyer l'arbre de recherche
                this.researchTree.innerHTML = '';
                
                // Cr√©er les branches
                const branches = ['production', 'energy', 'automation'];
                
                branches.forEach(branch => {
                    const branchElement = this.createResearchBranch(branch);
                    this.researchTree.appendChild(branchElement);
                });
                
                this.researchOverlay.style.display = 'block';
            },

            createResearchBranch(branch) {
                const branchData = GameData.RESEARCH_TREE.filter(node => node.branch === branch);
                const branchName = {
                    production: 'Production',
                    energy: '√ânergie',
                    automation: 'Automatisation'
                }[branch];
                
                const branchElement = document.createElement('div');
                branchElement.className = `research-branch branch-${branch}`;
                
                let branchHTML = `
                    <div class="branch-header">
                        <div class="branch-title">${branchName}</div>
                    </div>
                `;
                
                branchData.sort((a, b) => a.tier - b.tier).forEach(node => {
                    branchHTML += this.createResearchNode(node);
                });
                
                branchElement.innerHTML = branchHTML;
                
                // Ajouter les √©v√©nements aux n≈ìuds
                setTimeout(() => {
                    branchElement.querySelectorAll('.research-node').forEach(nodeElement => {
                        const nodeId = nodeElement.dataset.nodeId;
                        const node = branchData.find(n => n.id === nodeId);
                        
                        if (node) {
                            const isCompleted = Game.state.research.completed.includes(nodeId);
                            const prerequisitesMet = node.prerequisites.every(pre => 
                                Game.state.research.completed.includes(pre)
                            );
                            const canResearch = prerequisitesMet && !isCompleted && 
                                                Game.state.resources.research >= node.cost;
                            
                            if (canResearch) {
                                nodeElement.addEventListener('click', () => {
                                    Game.startResearch(nodeId);
                                    this.showResearchOverlay(); // Rafra√Æchir
                                });
                            }
                        }
                    });
                }, 0);
                
                return branchElement;
            },

            createResearchNode(node) {
                const isCompleted = Game.state.research.completed.includes(node.id);
                const prerequisitesMet = node.prerequisites.every(pre => 
                    Game.state.research.completed.includes(pre)
                );
                const canResearch = prerequisitesMet && !isCompleted && 
                                    Game.state.resources.research >= node.cost;
                
                let className = 'research-node';
                if (isCompleted) {
                    className += ' completed';
                } else if (canResearch) {
                    className += ' available';
                } else {
                    className += ' locked';
                }
                
                return `
                    <div class="${className}" data-node-id="${node.id}">
                        <div class="node-header">
                            <div class="node-name">${node.name}</div>
                            <div class="node-cost">üß™ ${node.cost}</div>
                        </div>
                        <div class="node-desc">${node.description}</div>
                        <div class="node-effect">${this.formatResearchEffect(node.effect)}</div>
                    </div>
                `;
            },

            formatResearchEffect(effect) {
                const effects = {
                    'production_multiplier': `+${Math.round((effect.value - 1) * 100)}% production ${effect.target === 'all' ? 'globale' : effect.target}`,
                    'consumption_reduction': `${Math.round((1 - effect.value) * 100)}% moins de consommation ${effect.target === 'energy' ? 'd\'√©nergie' : effect.target}`,
                    'passive_income': `+${effect.value} ${effect.target}/s passif`
                };
                
                return effects[effect.type] || 'Effet de recherche';
            },

            // Interface des missions
            initMissionsUI() {
                this.missionsOverlay = document.getElementById('missions-overlay');
                this.missionsClose = document.getElementById('missions-close');
                
                this.missionsClose.addEventListener('click', () => {
                    this.missionsOverlay.style.display = 'none';
                });
                
                // Initialiser les onglets
                this.initTabs();
                
                // Initialiser les filtres d'achievements
                this.initAchievementFilters();
            },

            initTabs() {
                const tabs = document.querySelectorAll('.tab-btn');
                const contents = document.querySelectorAll('.tab-content');
                
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabName = tab.dataset.tab;
                        
                        // Mettre √† jour les onglets actifs
                        tabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        // Afficher le contenu correspondant
                        contents.forEach(content => {
                            content.classList.remove('active');
                            if (content.id === `tab-${tabName}`) {
                                content.classList.add('active');
                            }
                        });
                        
                        // Mettre √† jour le contenu sp√©cifique
                        if (tabName === 'daily') {
                            this.updateDailyMissions();
                        } else if (tabName === 'achievements') {
                            this.updateAchievements();
                        } else if (tabName === 'stats') {
                            this.updateStats();
                        }
                    });
                });
            },

            initAchievementFilters() {
                const filterBtns = document.querySelectorAll('.filter-btn');
                
                filterBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        filterBtns.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        this.updateAchievements();
                    });
                });
            },

            showMissionsOverlay() {
                // Mettre √† jour les donn√©es
                this.updateMissionsData();
                
                // Afficher l'overlay
                this.missionsOverlay.style.display = 'block';
                
                // Charger le contenu de l'onglet actif
                const activeTab = document.querySelector('.tab-btn.active');
                if (activeTab) {
                    const tabName = activeTab.dataset.tab;
                    if (tabName === 'daily') {
                        this.updateDailyMissions();
                    } else if (tabName === 'achievements') {
                        this.updateAchievements();
                    } else if (tabName === 'stats') {
                        this.updateStats();
                    }
                }
            },

            updateMissionsData() {
                // Mettre √† jour les informations g√©n√©rales
                const streakValue = document.getElementById('streak-value');
                const completedToday = document.getElementById('completed-today');
                const achievementsCompleted = document.getElementById('achievements-completed');
                const achievementsProgress = document.getElementById('achievements-progress');
                const playTime = document.getElementById('play-time');
                
                if (streakValue) {
                    streakValue.textContent = `${Game.state.missions.streak} jours`;
                }
                
                if (completedToday) {
                    completedToday.textContent = `${Game.state.missions.completedToday}/3`;
                }
                
                if (achievementsCompleted) {
                    const completed = Game.state.missions.achievements.filter(a => a.completed).length;
                    achievementsCompleted.textContent = completed;
                }
                
                if (achievementsProgress) {
                    const total = Game.state.missions.achievements.length;
                    const completed = Game.state.missions.achievements.filter(a => a.completed).length;
                    const progress = total > 0 ? Math.round((completed / total) * 100) : 0;
                    achievementsProgress.textContent = `${progress}%`;
                }
                
                if (playTime) {
                    playTime.textContent = this.formatTime(Game.state.stats.playTime);
                }
                
                // Mettre √† jour le badge des missions
                this.updateMissionsBadge();
            },

            updateDailyMissions() {
                const listContainer = document.getElementById('daily-missions-list');
                if (!listContainer) return;
                
                listContainer.innerHTML = '';
                
                Game.state.missions.daily.forEach(mission => {
                    const missionElement = this.createMissionElement(mission);
                    listContainer.appendChild(missionElement);
                });
            },

            createMissionElement(mission) {
                const progress = mission.progress || 0;
                const target = mission.target || 1;
                const percent = Math.min((progress / target) * 100, 100);
                
                return `
                    <div class="mission-item ${mission.completed ? 'completed' : ''}">
                        <div class="mission-icon">${mission.icon}</div>
                        <div class="mission-details">
                            <div class="mission-header">
                                <div class="mission-title">${mission.title}</div>
                                <div class="mission-progress">${progress}/${target}</div>
                            </div>
                            <div class="mission-description">${mission.description}</div>
                            <div class="mission-progress-bar">
                                <div class="mission-progress-fill" style="width: ${percent}%"></div>
                            </div>
                            <div class="mission-reward">
                                ${Object.entries(mission.reward).map(([type, amount]) => {
                                    const icons = {
                                        money: 'üí∞',
                                        energy: '‚ö°',
                                        matter: 'üß±',
                                        research: 'üß™',
                                        xp: '‚≠ê',
                                        quantum: 'üîÆ'
                                    };
                                    return `<span class="reward-item">${icons[type] || ''} ${amount}</span>`;
                                }).join('')}
                            </div>
                        </div>
                        ${mission.completed ? '<div class="mission-completed">‚úì</div>' : ''}
                    </div>
                `;
            },

            updateAchievements() {
                const listContainer = document.getElementById('achievements-list');
                const filterBtn = document.querySelector('.filter-btn.active');
                const filter = filterBtn ? filterBtn.dataset.filter : 'all';
                
                if (!listContainer) return;
                
                listContainer.innerHTML = '';
                
                Game.state.missions.achievements.forEach(achievement => {
                    // Filtrer par tier
                    if (filter !== 'all' && achievement.tier !== filter) return;
                    
                    const achievementElement = this.createAchievementElement(achievement);
                    listContainer.appendChild(achievementElement);
                });
            },

            createAchievementElement(achievement) {
                const progress = achievement.progress || 0;
                const target = achievement.target || 1;
                const percent = Math.min((progress / target) * 100, 100);
                const tierColor = GameData.ACHIEVEMENT_TIER_COLORS[achievement.tier] || '#ffffff';
                
                return `
                    <div class="achievement-item ${achievement.tier} ${achievement.completed ? 'completed' : ''}">
                        <div class="achievement-icon" style="color: ${tierColor}">
                            ${achievement.icon}
                            ${achievement.completed ? '<div class="achievement-check">‚úì</div>' : ''}
                        </div>
                        <div class="achievement-details">
                            <div class="achievement-header">
                                <div class="achievement-title">${achievement.title}</div>
                                <div class="achievement-tier">${achievement.tier}</div>
                            </div>
                            <div class="achievement-description">${achievement.description}</div>
                            <div class="achievement-progress">
                                <div class="achievement-progress-bar">
                                    <div class="achievement-progress-fill" style="width: ${percent}%"></div>
                                </div>
                                <div class="achievement-progress-text">${progress}/${target}</div>
                            </div>
                            <div class="achievement-reward">
                                ${Object.entries(achievement.reward).map(([type, amount]) => {
                                    const icons = {
                                        money: 'üí∞',
                                        energy: '‚ö°',
                                        matter: 'üß±',
                                        research: 'üß™',
                                        xp: '‚≠ê',
                                        quantum: 'üîÆ',
                                        title: 'üè∑Ô∏è'
                                    };
                                    return `<span class="reward-item">${icons[type] || ''} ${amount}</span>`;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            },

            updateStats() {
                const statsContainer = document.getElementById('missions-stats');
                if (!statsContainer) return;
                
                const stats = [
                    { label: 'Machines plac√©es', value: Game.state.stats.machinesPlaced, icon: 'üè≠' },
                    { label: '√ânergie produite', value: Math.round(Game.state.stats.totalProduced.energy), icon: '‚ö°' },
                    { label: 'Mati√®re produite', value: Math.round(Game.state.stats.totalProduced.matter), icon: 'üß±' },
                    { label: 'Argent produit', value: Math.round(Game.state.stats.totalProduced.money), icon: 'üí∞' },
                    { label: 'Recherche produite', value: Math.round(Game.state.stats.totalProduced.research), icon: 'üß™' },
                    { label: 'Cha√Ænes cr√©√©es', value: Game.state.stats.chainsCreated || 0, icon: 'üîó' },
                    { label: '√âv√©nements compl√©t√©s', value: Game.state.stats.eventsCompleted || 0, icon: 'üå™Ô∏è' },
                    { label: 'Compl√©tions de prestige', value: Game.state.stats.prestigeCount || 0, icon: 'üåü' }
                ];
                
                statsContainer.innerHTML = stats.map(stat => `
                    <div class="mission-stat">
                        <div class="mission-stat-label">${stat.icon} ${stat.label}</div>
                        <div class="mission-stat-value">${this.formatNumber(stat.value)}</div>
                    </div>
                `).join('');
            },

            updateMissionsDisplay() {
                // Mettre √† jour le badge des missions
                this.updateMissionsBadge();
                
                // Si l'overlay est ouvert, le mettre √† jour
                if (this.missionsOverlay.style.display === 'block') {
                    this.updateMissionsData();
                    
                    const activeTab = document.querySelector('.tab-btn.active');
                    if (activeTab && activeTab.dataset.tab === 'daily') {
                        this.updateDailyMissions();
                    }
                }
            },

            updateMissionsBadge() {
                const badge = document.getElementById('missions-badge');
                if (!badge) return;
                
                // Compter les missions quotidiennes non compl√©t√©es
                const incompleteMissions = Game.state.missions.daily.filter(mission => !mission.completed).length;
                
                if (incompleteMissions > 0) {
                    badge.textContent = incompleteMissions;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            },

            // Interface de prestige
            initPrestige() {
                this.prestigeOverlay = document.getElementById('prestige-overlay');
                this.prestigeClose = document.getElementById('prestige-close');
                this.prestigeBtn = document.getElementById('prestige-btn');
                
                this.prestigeClose.addEventListener('click', () => {
                    this.prestigeOverlay.style.display = 'none';
                });
                
                if (this.prestigeBtn) {
                    this.prestigeBtn.addEventListener('click', () => {
                        if (Game.prestigeSystem.prestige()) {
                            this.showNotification('Prestige effectu√© ! Nouveau C≈ìur Quantique obtenu.', 'success');
                            this.updatePrestigeDisplay();
                            this.updateResources();
                            this.updateGrid();
                        } else {
                            this.showNotification('Prestige non disponible', 'error');
                        }
                    });
                }
            },

            showPrestigeOverlay() {
                this.updatePrestigeDisplay();
                this.prestigeOverlay.style.display = 'block';
            },

            updatePrestigeDisplay() {
                // Mettre √† jour les statistiques
                const quantumCores = document.getElementById('quantum-cores');
                const currentDimension = document.getElementById('current-dimension');
                const prestigeBonus = document.getElementById('prestige-bonus');
                const prestigeCount = document.getElementById('prestige-count');
                const prestigeCost = document.getElementById('prestige-cost');
                const nextBonus = document.getElementById('next-bonus');
                const prestigeStatus = document.getElementById('prestige-status');
                
                if (quantumCores) {
                    quantumCores.textContent = Game.state.resources.quantum || 0;
                }
                
                if (currentDimension) {
                    const dimension = GameData.DIMENSIONS.find(d => d.id === Game.prestigeSystem.currentDimension);
                    currentDimension.textContent = dimension ? dimension.name : 'Alpha';
                }
                
                if (prestigeBonus) {
                    const bonus = (Game.prestigeSystem.quantumCores * GameData.CONSTANTS.QUANTUM_CORE_BONUS * 100);
                    prestigeBonus.textContent = `+${bonus.toFixed(1)}%`;
                }
                
                if (prestigeCount) {
                    prestigeCount.textContent = Game.state.stats.prestigeCount || 0;
                }
                
                if (prestigeCost) {
                    const cost = Game.prestigeSystem.getPrestigeCost();
                    prestigeCost.textContent = this.formatNumber(cost);
                }
                
                if (nextBonus) {
                    const nextBonusValue = ((Game.prestigeSystem.quantumCores + 1) * GameData.CONSTANTS.QUANTUM_CORE_BONUS * 100);
                    nextBonus.textContent = `+${nextBonusValue.toFixed(1)}%`;
                }
                
                if (prestigeStatus) {
                    const canPrestige = Game.prestigeSystem.canPrestige();
                    prestigeStatus.textContent = canPrestige ? 'Disponible' : 'Indisponible';
                    prestigeStatus.className = canPrestige ? 'status-available' : 'status-unavailable';
                }
                
                // Mettre √† jour la liste des dimensions
                this.updateDimensionsList();
            },

            updateDimensionsList() {
                const listContainer = document.getElementById('dimensions-list');
                if (!listContainer) return;
                
                listContainer.innerHTML = '';
                
                GameData.DIMENSIONS.forEach(dimension => {
                    const dimensionElement = this.createDimensionElement(dimension);
                    listContainer.appendChild(dimensionElement);
                });
            },

            createDimensionElement(dimension) {
                const isUnlocked = Game.prestigeSystem.unlockedDimensions.includes(dimension.id);
                const isActive = Game.prestigeSystem.currentDimension === dimension.id;
                
                const element = document.createElement('div');
                element.className = `dimension-card ${isActive ? 'active' : ''} ${!isUnlocked ? 'locked' : ''}`;
                
                let requirementText = '';
                if (dimension.requirement && !isUnlocked) {
                    requirementText = `Requiert ${dimension.requirement.quantum_cores} C≈ìur${dimension.requirement.quantum_cores > 1 ? 's' : ''} Quantique${dimension.requirement.quantum_cores > 1 ? 's' : ''}`;
                }
                
                element.innerHTML = `
                    <div class="dimension-icon">${dimension.icon}</div>
                    <div class="dimension-name">${dimension.name}</div>
                    <div class="dimension-description">${dimension.description}</div>
                    <div class="dimension-bonus">
                        ${Object.entries(dimension.bonus).map(([key, value]) => {
                            const bonuses = {
                                'production': 'Production globale',
                                'energy_production': 'Production d\'√©nergie',
                                'matter_production': 'Production de mati√®re',
                                'energy_efficiency': 'Efficacit√© √©nerg√©tique',
                                'generator_efficiency': 'Efficacit√© des g√©n√©rateurs',
                                'extractor_efficiency': 'Efficacit√© des extracteurs'
                            };
                            return `${bonuses[key] || key}: +${Math.round((value - 1) * 100)}%`;
                        }).join('<br>')}
                    </div>
                    ${requirementText ? `<div class="dimension-requirement">${requirementText}</div>` : ''}
                `;
                
                if (isUnlocked && !isActive) {
                    element.addEventListener('click', () => {
                        if (Game.prestigeSystem.switchDimension(dimension.id)) {
                            this.updatePrestigeDisplay();
                            this.showNotification(`Dimension chang√©e pour ${dimension.name}`, 'success');
                        }
                    });
                }
                
                return element;
            },

            // Interface des param√®tres
            initSettings() {
                this.settingsOverlay = document.getElementById('settings-overlay');
                this.settingsClose = document.getElementById('settings-close');
                this.saveBtn = document.getElementById('save-btn');
                this.resetBtn = document.getElementById('reset-btn');
                
                this.settingsClose.addEventListener('click', () => {
                    this.settingsOverlay.style.display = 'none';
                });
                
                // Configurer les contr√¥les
                this.initSettingsControls();
                
                // Configurer les boutons
                if (this.saveBtn) {
                    this.saveBtn.addEventListener('click', () => {
                        Game.saveGame();
                        this.showNotification('Jeu sauvegard√© !', 'success');
                    });
                }
                
                if (this.resetBtn) {
                    this.resetBtn.addEventListener('click', () => {
                        Game.resetGame();
                    });
                }
            },

            initSettingsControls() {
                // Volume g√©n√©ral
                const masterVolume = document.getElementById('master-volume');
                const masterVolumeValue = document.getElementById('master-volume-value');
                
                if (masterVolume) {
                    masterVolume.value = Game.state.settings.masterVolume;
                    masterVolumeValue.textContent = `${Game.state.settings.masterVolume}%`;
                    
                    masterVolume.addEventListener('input', (e) => {
                        const value = e.target.value;
                        masterVolumeValue.textContent = `${value}%`;
                        Game.updateSettings({ masterVolume: parseInt(value) });
                    });
                }
                
                // Toggles
                const toggles = ['music', 'sfx', 'animations', 'notifications', 'autosave'];
                toggles.forEach(toggle => {
                    const element = document.getElementById(`${toggle}-toggle`);
                    if (element) {
                        element.checked = Game.state.settings[`${toggle}Enabled`];
                        element.addEventListener('change', (e) => {
                            Game.updateSettings({ [`${toggle}Enabled`]: e.target.checked });
                        });
                    }
                });
            },

            showSettingsOverlay() {
                this.updateSettingsDisplay();
                this.settingsOverlay.style.display = 'block';
            },

            updateSettingsDisplay() {
                // Mettre √† jour le temps de sauvegarde
                this.updateLastSaveTime();
            },

            updateLastSaveTime() {
                const lastSaveTime = document.getElementById('last-save-time');
                if (!lastSaveTime) return;
                
                if (Game.state.lastSaved) {
                    const now = Date.now();
                    const diff = now - Game.state.lastSaved;
                    const minutes = Math.floor(diff / 60000);
                    
                    if (minutes < 1) {
                        lastSaveTime.textContent = '√Ä l\'instant';
                    } else if (minutes < 60) {
                        lastSaveTime.textContent = `Il y a ${minutes} minute${minutes > 1 ? 's' : ''}`;
                    } else {
                        const hours = Math.floor(minutes / 60);
                        lastSaveTime.textContent = `Il y a ${hours} heure${hours > 1 ? 's' : ''}`;
                    }
                } else {
                    lastSaveTime.textContent = 'Jamais';
                }
            },

            // Syst√®me audio
            initAudio() {
                this.audioIndicator = document.getElementById('audio-indicator');
                this.audioIcon = document.getElementById('audio-icon');
                
                if (this.audioIndicator) {
                    this.audioIndicator.addEventListener('click', () => {
                        if (Game.audioSystem) {
                            Game.audioSystem.toggleMute();
                        }
                    });
                }
            },

            updateAudioIndicator() {
                if (!this.audioIndicator || !this.audioIcon) return;
                
                if (Game.state.settings.masterVolume > 0) {
                    this.audioIcon.textContent = 'üîä';
                    this.audioIndicator.classList.remove('muted');
                    this.audioIndicator.title = 'Son activ√©';
                } else {
                    this.audioIcon.textContent = 'üîá';
                    this.audioIndicator.classList.add('muted');
                    this.audioIndicator.title = 'Son d√©sactiv√©';
                }
            },

            // Informations sur la machine
            showMachineInfo(machine) {
                const def = GameData.MACHINES[machine.type];
                const production = Game.getMachineProduction(machine.type, machine.level);
                const consumption = Game.getMachineConsumption(machine.type, machine.level);
                
                // Cr√©er le contenu HTML
                let html = `
                    <h3>${def.name} Niveau ${machine.level}</h3>
                    <p>${def.description}</p>
                    <div class="machine-stats">
                        <h4>Production:</h4>
                        <ul>
                `;
                
                Object.entries(production).forEach(([resource, amount]) => {
                    const resourceInfo = GameData.RESOURCE_TYPES[resource];
                    html += `<li><span style="color: ${resourceInfo.color}">${resourceInfo.icon} ${resourceInfo.name}:</span> ${amount}/s</li>`;
                });
                
                html += `
                        </ul>
                        <h4>Consommation:</h4>
                        <ul>
                `;
                
                Object.entries(consumption).forEach(([resource, amount]) => {
                    const resourceInfo = GameData.RESOURCE_TYPES[resource];
                    html += `<li><span style="color: ${resourceInfo.color}">${resourceInfo.icon} ${resourceInfo.name}:</span> ${amount}/s</li>`;
                });
                
                html += `
                        </ul>
                        <h4>Position:</h4>
                        <p>X: ${machine.position.x + 1}, Y: ${machine.position.y + 1}</p>
                    </div>
                `;
                
                this.showInfoPanel(def.name, html);
            },

            // Panneau d'information
            showInfoPanel(title, content) {
                const panel = document.getElementById('info-panel');
                const infoContent = panel.querySelector('.info-content');
                const closeBtn = document.getElementById('info-close');
                
                if (!closeBtn) {
                    const closeButton = document.createElement('button');
                    closeButton.className = 'info-close';
                    closeButton.id = 'info-close';
                    closeButton.innerHTML = '√ó';
                    closeButton.addEventListener('click', () => {
                        panel.style.display = 'none';
                    });
                    panel.appendChild(closeButton);
                }
                
                infoContent.innerHTML = `<h3>${title}</h3>${content}`;
                panel.style.display = 'block';
            },

            // Notifications
            showNotification(message, type = 'info') {
                console.log(`Notification [${type}]: ${message}`);
                
                // V√©rifier si les notifications sont activ√©es
                if (!Game.state.settings.notificationsEnabled) return;
                
                const toastContainer = document.getElementById('toast-container');
                if (!toastContainer) return;
                
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;
                
                toastContainer.appendChild(toast);
                
                // Animation d'entr√©e
                setTimeout(() => {
                    toast.classList.add('show');
                }, 10);
                
                // Suppression apr√®s 3 secondes
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentNode === toastContainer) {
                            toastContainer.removeChild(toast);
                        }
                    }, 300);
                }, 3000);
            },

            showAchievementNotification(achievement) {
                const notification = document.getElementById('achievement-notification');
                if (!notification) return;
                
                const icon = notification.querySelector('#achievement-notif-icon');
                const name = notification.querySelector('#achievement-notif-name');
                const desc = notification.querySelector('#achievement-notif-desc');
                
                if (icon) icon.textContent = achievement.icon;
                if (name) name.textContent = achievement.title;
                if (desc) desc.textContent = achievement.description;
                
                // Afficher la notification
                notification.classList.add('show');
                
                // Masquer apr√®s 5 secondes
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 5000);
            },

            showQuestNotification(quest) {
                const notification = document.getElementById('quest-notification');
                if (!notification) return;
                
                const name = notification.querySelector('#quest-notif-name');
                const desc = notification.querySelector('#quest-notif-desc');
                
                if (name) name.textContent = quest.title;
                if (desc) desc.textContent = quest.description;
                
                // Afficher la notification
                notification.style.display = 'block';
                
                // Masquer apr√®s 5 secondes
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
            },

            showEventNotification(eventData) {
                const notification = document.getElementById('event-notification');
                if (!notification) return;
                
                const icon = notification.querySelector('#event-notif-icon');
                const name = notification.querySelector('#event-notif-name');
                const desc = notification.querySelector('#event-notif-desc');
                
                if (icon) icon.textContent = eventData.icon;
                if (name) name.textContent = eventData.name;
                if (desc) desc.textContent = eventData.description;
                
                // Afficher la notification
                notification.style.display = 'block';
                
                // Masquer apr√®s 5 secondes
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
            },

            // Affichage des √©v√©nements
            updateEventDisplay(eventData) {
                const eventsBar = document.getElementById('events-bar');
                const eventTimer = document.getElementById('event-timer');
                const eventName = document.querySelector('.event-name');
                
                if (!eventsBar || !eventTimer) return;
                
                const event = GameData.EVENTS[eventData.id];
                if (!event) return;
                
                // Mettre √† jour les informations
                eventName.textContent = event.name;
                
                // Calculer le temps restant
                const now = Date.now();
                const remaining = Math.max(0, Math.floor((eventData.endTime - now) / 1000));
                
                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;
                eventTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Afficher la barre
                eventsBar.style.display = 'block';
            },

            hideEventDisplay() {
                const eventsBar = document.getElementById('events-bar');
                if (eventsBar) {
                    eventsBar.style.display = 'none';
                }
            },

            // Mise √† jour des ressources
            updateResources() {
                Object.keys(GameData.RESOURCE_TYPES).forEach(resource => {
                    const element = document.getElementById(`resource-${resource}`);
                    if (element) {
                        const valueElement = element.querySelector('.resource-value');
                        if (valueElement) {
                            const value = Math.floor(Game.state.resources[resource]);
                            valueElement.textContent = this.formatNumber(value);
                        }
                    }
                });
            },

            updateXp() {
                const level = Game.state.progress.level;
                const currentXp = Game.state.progress.currentXp;
                
                // Trouver le prochain niveau
                const nextLevel = GameData.PLAYER_LEVELS.find(l => l.level === level + 1);
                const currentLevel = GameData.PLAYER_LEVELS.find(l => l.level === level);
                
                let xpPercentage = 0;
                if (nextLevel) {
                    const xpForNextLevel = nextLevel.xpRequired - currentLevel.xpRequired;
                    const xpProgress = currentXp - currentLevel.xpRequired;
                    xpPercentage = (xpProgress / xpForNextLevel) * 100;
                } else {
                    xpPercentage = 100;
                }
                
                // Mettre √† jour la barre XP
                const xpBar = document.getElementById('xp-bar');
                if (xpBar) {
                    xpBar.style.width = `${Math.min(xpPercentage, 100)}%`;
                }
            },

            updateLevel() {
                const levelValue = document.querySelector('.level-value');
                if (levelValue) {
                    levelValue.textContent = Game.state.progress.level;
                }
            },

            // Initialisation des boutons
            initButtons() {
                // Bouton de placement de machine
                const btnPlace = document.getElementById('btn-place');
                if (btnPlace) {
                    btnPlace.addEventListener('click', () => {
                        // Ouvrir le s√©lecteur sur une cellule vide si disponible
                        const emptyCell = this.findEmptyCell();
                        if (emptyCell) {
                            this.openMachineSelector(emptyCell.x, emptyCell.y);
                        } else {
                            this.showNotification('Aucune cellule disponible. Agrandissez la grille en montant de niveau.', 'warning');
                        }
                    });
                }
                
                // Bouton de recherche
                const btnResearch = document.getElementById('btn-research');
                if (btnResearch) {
                    btnResearch.addEventListener('click', () => {
                        this.showResearchOverlay();
                    });
                }
                
                // Bouton de missions
                const btnMissions = document.getElementById('btn-missions');
                if (btnMissions) {
                    btnMissions.addEventListener('click', () => {
                        this.showMissionsOverlay();
                    });
                }
                
                // Bouton de prestige
                const btnPrestige = document.getElementById('btn-prestige');
                if (btnPrestige) {
                    btnPrestige.addEventListener('click', () => {
                        this.showPrestigeOverlay();
                    });
                }
                
                // Bouton param√®tres
                const btnSettings = document.getElementById('btn-settings');
                if (btnSettings) {
                    btnSettings.addEventListener('click', () => {
                        this.showSettingsOverlay();
                    });
                }
            },

            // Utilitaires
            findEmptyCell() {
                const grid = Game.state.grid;
                for (let y = 0; y < grid.length; y++) {
                    for (let x = 0; x < grid[y].length; x++) {
                        if (grid[y][x].isUnlocked && !grid[y][x].machine) {
                            return { x, y };
                        }
                    }
                }
                return null;
            },

            formatCost(cost) {
                return Object.entries(cost)
                    .map(([resource, amount]) => {
                        const icons = {
                            money: 'üí∞',
                            energy: '‚ö°',
                            matter: 'üß±',
                            research: 'üß™'
                        };
                        return `${icons[resource] || ''} ${amount}`;
                    })
                    .join(' ');
            },

            formatNumber(num) {
                if (num >= 1000000) {
                    return (num / 1000000).toFixed(1) + 'M';
                }
                if (num >= 1000) {
                    return (num / 1000).toFixed(1) + 'K';
                }
                return Math.round(num).toString();
            },

            formatTime(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = Math.floor(seconds % 60);
                
                if (hours > 0) {
                    return `${hours}h ${minutes}m`;
                } else if (minutes > 0) {
                    return `${minutes}m ${secs}s`;
                } else {
                    return `${secs}s`;
                }
            }
        };

        // =============================================================================
        // INITIALISATION DU JEU
        // =============================================================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Quantum Factory - Chargement...');
            
            // Simuler un chargement progressif
            let progress = 0;
            const loadingInterval = setInterval(() => {
                progress += Math.random() * 20;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(loadingInterval);
                    
                    // Masquer l'√©cran de chargement
                    const loadingScreen = document.getElementById('loading');
                    if (loadingScreen) {
                        loadingScreen.style.opacity = '0';
                        setTimeout(() => {
                            loadingScreen.style.display = 'none';
                        }, 500);
                    }
                    
                    // Initialiser le jeu
                    initGame();
                }
                
                // Mettre √† jour la barre de progression
                const progressBar = document.getElementById('loading-progress');
                const progressText = document.getElementById('loading-text');
                
                if (progressBar) {
                    progressBar.style.width = `${progress}%`;
                }
                if (progressText) {
                    progressText.textContent = `${Math.round(progress)}%`;
                }
            }, 100);
        });

        function initGame() {
            // Initialiser les syst√®mes
            Game.init();
            
            // Initialiser l'interface
            UI.init();
            
            // Configurer les √©v√©nements globaux
            setupGlobalEvents();
            
            // D√©marrer avec un tutoriel si n√©cessaire
            if (!Game.state.tutorialCompleted) {
                startTutorial();
            }
            
            console.log('üéâ Quantum Factory - Pr√™t √† jouer !');
        }

        function setupGlobalEvents() {
            // Emp√™cher le menu contextuel par d√©faut
            document.addEventListener('contextmenu', (e) => {
                if (e.target.closest('.grid-cell')) {
                    // G√©r√© par l'interface
                } else {
                    e.preventDefault();
                }
            });
            
            // Fermer les menus en cliquant √† l'ext√©rieur
            document.addEventListener('click', (e) => {
                const contextMenu = document.getElementById('context-menu');
                if (contextMenu && contextMenu.style.display === 'block') {
                    if (!contextMenu.contains(e.target) && !e.target.closest('.grid-cell')) {
                        contextMenu.style.display = 'none';
                    }
                }
                
                const infoPanel = document.getElementById('info-panel');
                if (infoPanel && infoPanel.style.display === 'block') {
                    if (!infoPanel.contains(e.target)) {
                        infoPanel.style.display = 'none';
                    }
                }
            });
            
            // Sauvegarder lors de la fermeture de la page
            window.addEventListener('beforeunload', () => {
                Game.saveGame();
            });
            
            // Support tactile pour mobile
            let touchStartTime = 0;
            let touchStartX = 0;
            let touchStartY = 0;
            
            document.addEventListener('touchstart', (e) => {
                touchStartTime = Date.now();
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            });
            
            document.addEventListener('touchend', (e) => {
                const touchEndTime = Date.now();
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                const duration = touchEndTime - touchStartTime;
                const distance = Math.sqrt(
                    Math.pow(touchEndX - touchStartX, 2) + 
                    Math.pow(touchEndY - touchStartY, 2)
                );
                
                // Si le toucher est long et peu mobile, c'est un appui long
                if (duration > 500 && distance < 10) {
                    const target = e.target;
                    const cell = target.closest('.grid-cell');
                    if (cell) {
                        e.preventDefault();
                        const x = parseInt(cell.dataset.x);
                        const y = parseInt(cell.dataset.y);
                        UI.showContextMenu({
                            clientX: touchEndX,
                            clientY: touchEndY,
                            preventDefault: () => {}
                        }, x, y);
                    }
                }
            });
        }

        function startTutorial() {
            // Premier tutoriel simple
            setTimeout(() => {
                UI.showNotification('üëã Bienvenue dans Quantum Factory !', 'info');
                UI.showNotification('üí° Appuyez sur le bouton "Placer" pour commencer', 'info');
                
                // Marquer le tutoriel comme compl√©t√©
                Game.state.tutorialCompleted = true;
                Game.saveGame();
            }, 1000);
        }

        // Exposer les objets globaux pour le d√©bogage
        window.Game = Game;
        window.UI = UI;
        window.GameData = GameData;

        console.log('‚úÖ Script JavaScript charg√© avec succ√®s !');
    </script>
</body>
</html>
